<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ØµØ­ÙŠÙØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© | ØµÙˆØª Ø§Ù„ÙˆØ§Ù‚Ø¹</title>

    <!-- Manifest + PWA -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#050510" />
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet" />

    <!-- Libraries -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Tailwind Custom Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Tajawal', 'sans-serif'] },
                    colors: {
                        navy: { 900: '#050510', 800: '#0a0a15', 700: '#151525' },
                        gold: { 400: '#D4AF37', 500: '#C5A028' }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s ease infinite',
                        'fade-in': 'fadeIn 0.4s ease-out'
                    }
                }
            }
        }
    </script>

    <!-- Custom Styles (Optimized) -->
    <style>
        body {
            background-color: #050510;
            color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        .glass-nav {
            background: rgba(5, 5, 16, 0.9);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .glass-panel {
            background: rgba(21, 21, 37, 0.75);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }
        .editor-content:empty:before {
            content: attr(placeholder);
            color: #6b7280;
        }
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-left-color: #D4AF37;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="antialiased selection:bg-gold-400 selection:text-black pb-20 md:pb-0">

    <!-- ==================== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø²ÙˆØ§Ø± (Public View) ==================== -->
    <div id="public-view" class="transition-opacity duration-500">

        <!-- Navigation -->
        <nav class="fixed w-full z-40 glass-nav top-0 transition-all duration-300">
            <div class="container mx-auto px-4 h-16 flex justify-between items-center">
                
                <!-- Logo -->
                <div class="text-3xl font-black text-gold-400 cursor-pointer flex items-center gap-2 tracking-tighter"
                     onclick="window.location.reload()">
                    Ø§Ù„Ù€Ø­Ù‚ÙŠÙ‚Ø©<span class="text-white">.</span>
                </div>

                <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
                <div class="hidden md:flex items-center gap-6 ml-6">
                    <a href="index.html" class="text-white hover:text-gold-400 text-sm font-medium transition">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                    <a href="news.html" class="text-white hover:text-gold-400 text-sm font-medium transition">ğŸ“° Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</a>
                    <a href="categories.html" class="text-white hover:text-gold-400 text-sm font-medium transition">ğŸ“‚ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a>
                    <a href="about.html" class="text-white hover:text-gold-400 text-sm font-medium transition">â„¹ï¸ Ø¹Ù†Ø§</a>
                    <a href="contact.html" class="text-white hover:text-gold-400 text-sm font-medium transition">ğŸ“ Ø§ØªØµÙ„</a>
                </div>

                <!-- Buttons -->
                <div class="flex gap-3 items-center">
                    <button id="install-btn"
                        class="hidden bg-gold-400 text-black text-xs font-bold px-3 py-1.5 rounded-full animate-pulse flex items-center gap-1">
                        <i data-lucide="download" class="w-3 h-3"></i> ØªØ«Ø¨ÙŠØª
                    </button>

                    <button onclick="openSettings()"
                        class="text-gold-400 p-2 rounded-full hover:bg-white/10">
                        <i data-lucide="cpu" class="w-5 h-5"></i>
                    </button>

                    <button onclick="toggleAdminView()"
                        class="text-white bg-white/10 px-4 py-1.5 rounded-full hover:bg-gold-400 hover:text-black transition-all text-xs font-bold flex items-center gap-2 shadow-lg">
                        <i data-lucide="shield" class="w-4 h-4"></i>
                        <span class="hidden md:inline">ØºØ±ÙØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</span>
                    </button>
                </div>

            </div>
        </nav>

        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¹Ø§Ø¬Ù„Ø© -->
        <div class="fixed top-16 w-full z-30 bg-navy-900 border-b border-white/5 py-2 overflow-hidden shadow-md">
            <div class="container mx-auto px-4 flex items-center">
                <span class="text-gold-400 text-[10px] font-bold ml-3 border-l border-gray-700 px-2 whitespace-nowrap flex items-center gap-1">
                    <div class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></div>
                    Ø¹Ø§Ø¬Ù„
                </span>
                <div class="w-full overflow-hidden relative h-4">
                    <div id="ticker-content"
                         class="absolute whitespace-nowrap animate-[marquee_20s_linear_infinite] text-[10px] text-gray-300">
                        Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ==================== -->

        <main class="pt-32 container mx-auto px-4 min-h-screen">

            <!-- Hero -->
            <section id="hero-section"
                class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-10">
                <div class="lg:col-span-12 flex flex-col items-center justify-center h-64 gap-4 border border-white/5 rounded-2xl bg-white/5 animate-pulse">
                    <div class="loader"></div>
                </div>
            </section>

            <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± -->
            <section class="grid grid-cols-1 lg:grid-cols-12 gap-8">

                <!-- Articles -->
                <div id="news-container"
                    class="lg:col-span-8">
                    <div class="space-y-4">
                        <div class="h-28 bg-white/5 rounded-xl animate-pulse"></div>
                        <div class="h-28 bg-white/5 rounded-xl animate-pulse"></div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-4 hidden lg:block sticky top-36 h-fit">
                    <div class="bg-navy-800/50 p-6 rounded-2xl border border-white/5 shadow-xl backdrop-blur-sm">

                        <h3 class="text-gold-400 font-bold mb-6 flex items-center gap-2 border-b border-white/5 pb-3">
                            <i data-lucide="trending-up" class="w-4 h-4"></i>
                            Ø§Ù„Ø£ÙƒØ«Ø± Ù‚Ø±Ø§Ø¡Ø©
                        </h3>

                        <div id="sidebar-content" class="space-y-4"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- ==================== Article Modal ==================== -->
    <div id="article-modal"
        class="fixed inset-0 z-50 bg-[#050510] hidden overflow-y-auto animate-fade-in">

        <button onclick="closeArticleModal()"
            class="fixed top-6 left-6 z-50 bg-black/50 text-white p-2 rounded-full hover:bg-white hover:text-black transition backdrop-blur-md border border-white/10">
            <i data-lucide="x" class="w-6 h-6"></i>
        </button>

        <!-- Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© -->
        <div class="relative h-[40vh] md:h-[50vh] w-full">
            <img id="modal-img"
                 src=""
                 class="w-full h-full object-cover" />

            <div class="absolute inset-0 bg-gradient-to-t from-[#050510] via-[#050510]/60 to-transparent"></div>

            <div class="absolute bottom-0 right-0 p-6 md:p-12 w-full max-w-4xl mx-auto">
                <span id="modal-cat"
                      class="bg-gold-400 text-black text-xs font-bold px-3 py-1 rounded-full mb-4 inline-block"></span>

                <h1 id="modal-title"
                    class="text-3xl md:text-5xl font-black text-white leading-tight mb-4 drop-shadow-lg"></h1>

                <div class="flex items-center gap-4 text-sm text-gray-300">
                    <span class="flex items-center gap-1">
                        <i data-lucide="clock" class="w-4 h-4 text-gold-400"></i>
                        <span id="modal-date"></span>
                    </span>

                    <span class="flex items-center gap-1">
                        <i data-lucide="user" class="w-4 h-4 text-gold-400"></i>
                        <span id="modal-author"></span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Ù†Øµ Ø§Ù„Ù…Ù‚Ø§Ù„ -->
        <div class="max-w-3xl mx-auto px-6 py-12">
            <div class="prose prose-invert prose-lg max-w-none">
                <p id="modal-body" class="leading-loose text-gray-300"></p>
            </div>
        </div>

    </div>

    <!-- ==================== Admin System (Dashboard) ==================== -->
    <div id="admin-view"
         class="hidden fixed inset-0 z-[60] bg-[#020205] overflow-y-auto">

        <!-- Login Gate -->
        <div id="login-gate"
             class="min-h-screen flex items-center justify-center p-4">
            <div class="glass-panel p-10 rounded-3xl w-full max-w-md text-center relative">

                <button onclick="toggleAdminView()"
                    class="absolute top-4 left-4 text-gray-500 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>

                <h1 class="text-4xl font-black text-white mb-2">
                    Ø¨ÙˆØ§Ø¨Ø©<span class="text-gold-400"> Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</span>
                </h1>
                <p class="text-gray-500 text-xs mb-6">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰</p>

                <form onsubmit="handleRealLogin(event)"
                      class="space-y-6">

                    <input type="email" id="login-email"
                        placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø±Ø³Ù…ÙŠ"
                        class="w-full bg-[#0a0a15] border border-white/10 rounded-xl py-3 px-4 text-white focus:border-gold-400 outline-none" />

                    <input type="password" id="login-password"
                        placeholder="Ø§Ù„Ø´ÙØ±Ø©"
                        class="w-full bg-[#0a0a15] border border-white/10 rounded-xl py-3 px-4 text-white focus:border-gold-400 outline-none" />

                    <div id="login-error"
                        class="text-red-500 text-xs hidden bg-red-900/20 p-2 rounded">
                        Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©
                    </div>

                    <button id="login-btn"
                        class="w-full bg-gold-400 text-black font-bold py-4 rounded-xl hover:bg-white transition shadow-lg">
                        Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
                    </button>
                </form>

                <div class="mt-4 pt-4 border-t border-white/10">
                    <button onclick="forceAdminEnter()"
                        class="text-xs text-gray-500 hover:text-gold-400">
                        Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ¶Ø¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ (Ù…Ø­Ù„ÙŠ)
                    </button>
                </div>

            </div>
        </div>

        <!-- Dashboard UI -->
        <div id="dashboard-ui" class="hidden min-h-screen flex flex-col lg:flex-row">
            
            <!-- Sidebar -->
            <aside class="w-full lg:w-64 bg-navy-900 border-l border-white/5 flex flex-col">

                <div class="h-20 flex items-center px-6 border-b border-white/5 justify-between lg:justify-start">
                    <h2 class="text-xl font-bold text-white">ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
                    <button onclick="toggleAdminView()" class="lg:hidden text-gray-400">
                        <i data-lucide="x"></i>
                    </button>
                </div>

                <div class="flex-1 p-4 space-y-2 overflow-y-auto">
                    <button onclick="switchDashView('editor', this)"
                        class="sidebar-link w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-white/5 rounded-lg text-sm font-medium active">
                        <i data-lucide="pen-tool" class="w-4 h-4"></i> Ø§Ù„Ù…Ø­Ø±Ø± Ø§Ù„Ø°ÙƒÙŠ
                    </button>

                    <button onclick="switchDashView('articles', this)"
                        class="sidebar-link w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-white/5 rounded-lg text-sm font-medium">
                        <i data-lucide="file-text" class="w-4 h-4"></i> Ø§Ù„Ø£Ø±Ø´ÙŠÙ
                    </button>

                    <button onclick="switchDashView('settings', this)"
                        class="sidebar-link w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-white/5 rounded-lg text-sm font-medium">
                        <i data-lucide="settings" class="w-4 h-4"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                    </button>
                </div>

                <div class="p-4 border-t border-white/5">
                    <button onclick="logout()"
                        class="w-full flex items-center gap-2 text-red-400 hover:text-red-300 text-sm p-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
                    </button>

                    <button onclick="toggleAdminView()"
                        class="w-full flex items-center gap-2 text-gray-400 hover:text-white text-sm p-2 mt-2">
                        <i data-lucide="eye" class="w-4 h-4"></i> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹
                    </button>
                </div>

            </aside>

            <!-- Main Workspace -->
            <div class="flex-1 bg-[#020205] overflow-y-auto p-6">

                <div id="status-bar"
                    class="hidden mb-4 p-2 bg-yellow-500/10 border border-yellow-500/30 text-yellow-500 text-xs rounded-lg flex items-center gap-2">
                    <i data-lucide="wifi-off" class="w-4 h-4"></i> ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ (Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØµÙ„Ø©)
                </div>

                <!-- Editor Section -->
                <div id="sec-editor"
                    class="view-section space-y-6 max-w-4xl mx-auto">

                    <h2 class="text-2xl font-bold text-white mb-6">Ù†Ø´Ø± Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯</h2>

                    <input id="news-title"
                        type="text"
                        placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±..."
                        class="w-full bg-transparent text-3xl font-black text-white border-none focus:ring-0 px-0 placeholder-gray-700" />

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <select id="news-category"
                            class="bg-navy-800 border border-white/10 rounded-lg p-3 text-white focus:border-gold-400">
                            <option>Ø£Ø®Ø¨Ø§Ø± Ù…Ø­Ù„ÙŠØ©</option>
                            <option>Ø±ÙŠØ§Ø¶Ø©</option>
                            <option>Ø§Ù‚ØªØµØ§Ø¯</option>
                            <option>Ø«Ù‚Ø§ÙØ©</option>
                        </select>

                        <input type="text" id="news-image"
                            placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©..."
                            class="bg-navy-800 border border-white/10 rounded-lg p-3 text-white focus:border-gold-400" />
                    </div>

                    <!-- AI Tools -->
                    <div class="flex flex-wrap gap-2">
                        <button onclick="triggerAI('title')"
                            class="px-3 py-1.5 rounded-full border border-white/10 text-xs text-gold-400 hover:bg-gold-400 hover:text-black flex items-center gap-1">
                            <i data-lucide="sparkles" class="w-3 h-3"></i> Ø¹Ù†Ø§ÙˆÙŠÙ†
                        </button>

                        <button onclick="triggerAI('grammar')"
                            class="px-3 py-1.5 rounded-full border border-white/10 text-xs text-green-400 hover:bg-green-400 hover:text-black flex items-center gap-1">
                            <i data-lucide="check" class="w-3 h-3"></i> ØªØ¯Ù‚ÙŠÙ‚
                        </button>

                        <button onclick="generateImage()"
                            class="px-3 py-1.5 rounded-full border border-white/10 text-xs text-blue-400 hover:bg-blue-400 hover:text-black flex items-center gap-1">
                            <i data-lucide="image" class="w-3 h-3"></i> ØªÙˆÙ„ÙŠØ¯ ØµÙˆØ±Ø©
                        </button>
                    </div>

                    <div id="ai-output"
                         class="hidden p-4 bg-white/5 rounded-lg text-sm text-gray-300 border-l-2 border-gold-400"></div>

                    <div id="editor"
                        class="editor-content w-full h-[300px] text-lg text-gray-300 leading-loose border border-white/5 p-4 rounded-xl overflow-y-auto"
                        contenteditable="true"
                        placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§...">
                    </div>

                    <button id="publish-btn"
                        onclick="publishAction()"
                        class="w-full bg-gold-400 text-black font-bold py-3 rounded-lg hover:bg-white transition shadow-lg">
                        Ù†Ø´Ø± ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ğŸš€
                    </button>

                </div>

                <!-- Archive -->
                <div id="sec-articles"
                     class="view-section hidden max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-white font-bold text-xl">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h3>
                        <button onclick="loadAdminData()" class="text-gold-400 text-sm hover:underline">ØªØ­Ø¯ÙŠØ«</button>
                    </div>
                    <div id="admin-articles-list" class="space-y-2"></div>
                </div>

                <!-- Settings -->
                <div id="sec-settings"
                     class="view-section hidden max-w-md mx-auto">
                    <div class="glass-panel p-6 rounded-2xl">
                        <h3 class="text-white font-bold mb-4">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
                        <input type="password"
                            id="api-key-setting"
                            placeholder="Gemini API Key"
                            class="w-full bg-black/50 p-3 rounded-xl text-white mb-4 border border-white/10 focus:border-gold-400" />
                        <button onclick="saveApiKey()"
                            class="w-full bg-gold-400 text-black font-bold py-2 rounded-xl hover:bg-white">
                            Ø­ÙØ¸
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ==================== Toast Notification ==================== -->
    <div id="toast"
        class="fixed bottom-6 left-6 bg-navy-900 border border-gold-400/50 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-24 opacity-0 transition-all duration-300 flex items-center gap-3 z-[100]">
        <span id="toast-msg" class="font-bold">ØªÙ…</span>
    </div>

    <!-- Settings Modal for AI (Visitor) -->
    <div id="settings-modal"
         class="fixed inset-0 z-[80] bg-black/90 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-navy-800 w-full max-w-sm rounded-2xl p-6 border border-gold-400/20 shadow-2xl">
            <h3 class="text-white font-bold mb-4 text-lg">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
            <input type="password" id="api-key-input" placeholder="Gemini API Key"
                class="w-full bg-black/50 p-3 rounded-xl text-white mb-4 border border-white/10 focus:border-gold-400 outline-none text-sm" />
            <div class="flex gap-3">
                <button onclick="saveApiKey()"
                    class="flex-1 bg-gold-400 text-black font-bold py-2 rounded-xl hover:bg-white transition">Ø­ÙØ¸</button>
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')"
                    class="flex-1 bg-white/10 text-white py-2 rounded-xl">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

<script>
/* ---------------------------------------------------------
    1) Lucide Icons Init
---------------------------------------------------------*/
function initIcons() {
    if (window.lucide) lucide.createIcons();
}
document.addEventListener('DOMContentLoaded', initIcons);

/* ---------------------------------------------------------
    2) Firebase Config
---------------------------------------------------------*/
const firebaseConfig = {
    apiKey: "AIzaSyD7b1PZY26GN6hR2pliqiFRgyMsNyRlWOs",
    authDomain: "alhqyqa-62b0e.firebaseapp.com",
    projectId: "alhqyqa-62b0e",
    storageBucket: "alhqyqa-62b0e.firebasestorage.app",
    messagingSenderId: "354014970954",
    appId: "1:354014970954:web:435ca4eb0cbbfcfd1152b3"
};

let isOfflineMode = false;
const LOCAL_NEWS_KEY = "local_news_db";

/* ---------------------------------------------------------
    3) Local Storage Helpers (Offline Mode)
---------------------------------------------------------*/
function getLocalNews() {
    try {
        return JSON.parse(localStorage.getItem(LOCAL_NEWS_KEY) || "[]");
    } catch {
        return [];
    }
}
function saveLocalNews(item) {
    const current = getLocalNews();
    current.unshift(item);
    localStorage.setItem(LOCAL_NEWS_KEY, JSON.stringify(current));
}

/* ---------------------------------------------------------
    4) Firebase Boot
---------------------------------------------------------*/
try {
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();

    /* Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    auth.onAuthStateChanged((user) => {
        if (user && !user.isAnonymous) {
            showDashboard();
            loadAdminData();
        }
        fetchNews();
    });

    /* Ø¯Ø®ÙˆÙ„ Ø²Ø§Ø¦Ø± */
    if (!auth.currentUser) auth.signInAnonymously().catch(() => enableOfflineMode());

    /* ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù */
    window.handleRealLogin = async (e) => {
        e.preventDefault();
        if (isOfflineMode) return forceAdminEnter();

        const emailInput = document.getElementById('login-email');
        const passInput = document.getElementById('login-password');
        const errDiv = document.getElementById('login-error');

        try {
            await auth.signInWithEmailAndPassword(emailInput.value, passInput.value);
        } catch {
            errDiv.classList.remove('hidden');
        }
    };

} catch (err) {
    enableOfflineMode();
}

/* ---------------------------------------------------------
    5) Fetching News (Online/Offline)
---------------------------------------------------------*/
async function fetchNews() {
    if (isOfflineMode) return renderLocalData();

    try {
        const snap = await firebase.firestore().collection("news").limit(20).get();

        if (snap.empty) {
            const local = getLocalNews();
            if (local.length) return renderSite(local);
            return renderEmptyState();
        }

        let data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

        window.newsData = data;
        renderSite(data);

    } catch {
        enableOfflineMode();
    }
}

/* ---------------------------------------------------------
    6) Publish Article
---------------------------------------------------------*/
window.publishAction = async () => {
    const btn = document.getElementById('publish-btn');
    const title = document.getElementById('news-title').value.trim();
    const category = document.getElementById('news-category').value;
    const img = document.getElementById('news-image').value || "https://via.placeholder.com/800x400";
    const content = document.getElementById('editor').innerText.trim();

    if (!title || !content) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

    btn.disabled = true;
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...";

    const article = {
        id: "local_" + Date.now(),
        title,
        category,
        img,
        desc: content,
        author: firebase.auth().currentUser?.email || "LocalAdmin",
        date: new Date().toLocaleDateString("ar-SA"),
        timestamp: { seconds: Date.now() / 1000 }
    };

    if (isOfflineMode) {
        saveLocalNews(article);
        finishPublish(article, "ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ âš ï¸");
        return;
    }

    try {
        await firebase.firestore().collection("news").add(article);
        finishPublish(article, "ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹ âœ…");
    } catch {
        saveLocalNews(article);
        finishPublish(article, "ÙØ´Ù„ Ø§Ù„Ø³Ø­Ø§Ø¨ â€” ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ âš ï¸");
    }
};

function finishPublish(article, msg) {
    const btn = document.getElementById('publish-btn');
    btn.disabled = false;
    btn.innerText = "Ù†Ø´Ø± ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹";

    document.getElementById('news-title').value = "";
    document.getElementById('editor').innerText = "";

    const current = window.newsData || [];
    current.unshift(article);
    window.newsData = current;

    renderSite(current);
    loadAdminData();
    showToast(msg);
}

/* ---------------------------------------------------------
    7) Dashboard + Views
---------------------------------------------------------*/
function showDashboard() {
    document.getElementById('login-gate').classList.add("hidden");
    document.getElementById('dashboard-ui').classList.remove("hidden");
}

/* ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
window.switchDashView = (v, btn) => {
    document.querySelectorAll(".view-section").forEach(e => e.classList.add("hidden"));
    document.getElementById(`sec-${v}`).classList.remove("hidden");

    document.querySelectorAll(".sidebar-link").forEach(e => e.classList.remove("active"));
    btn.classList.add("active");

    if (v === "articles") loadAdminData();
};

/* Ø®Ø±ÙˆØ¬ */
window.logout = () => {
    firebase.auth().signOut().then(() => {
        document.getElementById('dashboard-ui').classList.add("hidden");
        document.getElementById('login-gate').classList.remove("hidden");
        if (!isOfflineMode) firebase.auth().signInAnonymously();
    });
};

/* ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
window.toggleAdminView = () => {
    const adminView = document.getElementById('admin-view');
    const loginGate = document.getElementById('login-gate');
    const dashboardUi = document.getElementById('dashboard-ui');
    
    adminView.classList.toggle("hidden");

    const isLoggedIn =
        (firebase.auth().currentUser && !firebase.auth().currentUser.isAnonymous) ||
        (isOfflineMode && !dashboardUi.classList.contains("hidden"));

    loginGate.classList.toggle("hidden", isLoggedIn);
    dashboardUi.classList.toggle("hidden", !isLoggedIn);
};

/* ---------------------------------------------------------
    8) AI (Gemini)
---------------------------------------------------------*/
let userApiKey = localStorage.getItem("gemini_api_key") || "";

window.saveApiKey = () => {
    const keyInput = document.getElementById('api-key-setting');
    const keyModalInput = document.getElementById('api-key-input');
    const key = keyInput ? keyInput.value : (keyModalInput ? keyModalInput.value : '');
    
    if (!key) return;
    localStorage.setItem("gemini_api_key", key);
    userApiKey = key;
    showToast("ØªÙ… Ø­ÙØ¸ Ù…ÙØªØ§Ø­ Gemini");
    
    const settingsModal = document.getElementById('settings-modal');
    if (settingsModal) settingsModal.classList.add('hidden');
};

window.openSettings = () => {
    document.getElementById('settings-modal').classList.remove('hidden');
};

async function callGemini(prompt, system) {
    if (!userApiKey) return alert("Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ API");

    try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`;

        const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: system }] }
            })
        });

        const data = await res.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text;

    } catch {
        return null;
    }
}

window.triggerAI = async (mode) => {
    const out = document.getElementById('ai-output');
    out.classList.remove("hidden");
    out.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦";

    const text = document.getElementById('editor').innerText;
    let prompt = "";

    if (mode === "title") prompt = `Ø§Ù‚ØªØ±Ø­ Ø¹Ù†Ø§ÙˆÙŠÙ† Ù„Ø®Ø¨Ø±: ${text}`;
    else if (mode === "grammar") prompt = `ØµØ­Ø­ Ù„ØºÙˆÙŠØ§Ù‹ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ: ${text}`;

    const result = await callGemini(prompt, "Ù…Ø³Ø§Ø¹Ø¯ ØµØ­ÙÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ");

    if (!result) return (out.innerHTML = "Ø®Ø·Ø£â€¦");

    out.innerHTML = marked.parse(result);
    if (mode === "grammar") document.getElementById('editor').innerText = result;
};

/* ØªÙˆÙ„ÙŠØ¯ ØµÙˆØ±Ø© */
window.generateImage = async () => {
    const title = document.getElementById('news-title').value;
    if (!title) return alert("Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø± Ø£ÙˆÙ„Ø§Ù‹");

    const prompt = await callGemini(
        `Describe news photo for: "${title}" in English`,
        "Prompt Engineer"
    );

    if (!prompt) return;

    try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=${userApiKey}`;

        const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                instances: [{ prompt }],
                parameters: { sampleCount: 1 }
            })
        });

        const data = await res.json();
        const img = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
        document.getElementById('news-image').value = img;
        showToast("ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø©");

    } catch {
        alert("ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø©");
    }
};

/* ---------------------------------------------------------
    9) Rendering the site
---------------------------------------------------------*/
function renderSite(news) {
    if (!news || !news.length) return renderEmptyState();

    const hero = news[0];
    const rest = news.slice(1);

    document.getElementById('ticker-content').innerText = " â€¢ " + news.map(n => n.title).join(" â€¢ ");

    document.getElementById('hero-section').innerHTML = `
        <div onclick="openArticle('${hero.id}')"
            class="lg:col-span-12 relative group rounded-2xl overflow-hidden h-[300px] lg:h-[450px] cursor-pointer shadow-2xl border border-white/10">

            <img src="${hero.img}"
                 class="w-full h-full object-cover group-hover:scale-105 transition duration-700"
                 onerror="this.src='https://via.placeholder.com/800x400'" />

            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/30 to-transparent"></div>

            <div class="absolute bottom-0 p-6 lg:p-10">
                <h1 class="text-2xl md:text-4xl font-black text-white mb-3">${hero.title}</h1>
                <p class="text-gray-200 text-sm hidden md:block line-clamp-2">${hero.desc}</p>
            </div>
        </div>
    `;

    document.getElementById('news-container').innerHTML = rest
        .map(
            (n) => `
        <div onclick="openArticle('${n.id}')"
            class="flex gap-4 mb-4 bg-white/5 p-3 rounded-xl border border-white/5 hover:border-gold-400/30 group cursor-pointer">

            <div class="w-24 h-24 md:w-32 md:h-24 overflow-hidden rounded-lg">
                <img src="${n.img}"
                     class="w-full h-full object-cover"
                     onerror="this.src='https://via.placeholder.com/200'" />
            </div>

            <div class="flex flex-col justify-center flex-1">
                <span class="text-[10px] text-gold-400 font-bold mb-1">${n.category}</span>
                <h3 class="text-white font-bold leading-snug group-hover:text-gold-400 line-clamp-2">
                    ${n.title}
                </h3>
            </div>
        </div>
    `
        )
        .join("");

    document.getElementById('sidebar-content').innerHTML = [...news]
        .sort(() => Math.random() - 0.5)
        .slice(0, 5)
        .map(
            (n, i) => `
        <div onclick="openArticle('${n.id}')"
            class="flex gap-3 items-center cursor-pointer group border-b border-white/5 pb-2 last:border-0">

            <span class="text-gold-400 font-black text-lg w-4">${i + 1}</span>
            <h4 class="text-gray-300 text-xs group-hover:text-white line-clamp-2">
                ${n.title}
            </h4>
        </div>
    `
        )
        .join("");

    initIcons();
}

/* ---------------------------------------------------------
    10) Article Modal
---------------------------------------------------------*/
window.openArticle = (id) => {
    const art = window.newsData.find(n => n.id === id);
    if (!art) return;

    document.getElementById('modal-img').src = art.img;
    document.getElementById('modal-cat').innerText = art.category;
    document.getElementById('modal-title').innerText = art.title;
    document.getElementById('modal-date').innerText = art.date;
    document.getElementById('modal-author').innerText = art.author;
    document.getElementById('modal-body').innerHTML = marked.parse(art.desc);

    document.getElementById('article-modal').classList.remove("hidden");
};

window.closeArticleModal = () =>
    document.getElementById('article-modal').classList.add("hidden");

/* ---------------------------------------------------------
    11) Admin Archive
---------------------------------------------------------*/
window.loadAdminData = async () => {
    const local = getLocalNews();
    let data = [...local];

    if (!isOfflineMode) {
        try {
            const snap = await firebase.firestore().collection("news").limit(20).get();
            data.push(...snap.docs.map(doc => doc.data()));
        } catch {}
    }

    document.getElementById('admin-articles-list').innerHTML = data
        .map(
            (d) =>
                `<div class="bg-white/5 p-3 rounded flex justify-between items-center border-b border-white/5">
                    <span class="text-white font-bold text-sm truncate w-2/3">${d.title}</span>
                    <span class="text-xs text-gray-500">${d.date}</span>
                </div>`
        )
        .join("");
};

/* ---------------------------------------------------------
    12) Offline Mode
---------------------------------------------------------*/
function enableOfflineMode() {
    isOfflineMode = true;

    document.getElementById('ticker-content').innerText = " â€¢ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©)";
    document.getElementById('status-bar').classList.remove("hidden");

    renderLocalData();
}

function renderLocalData() {
    const local = getLocalNews();
    if (local.length) {
        window.newsData = local;
        renderSite(local);
    } else renderMock("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©");
}

window.forceAdminEnter = () => {
    isOfflineMode = true;
    showDashboard();
    document.getElementById('status-bar').classList.remove("hidden");
    loadAdminData();
};

/* ---------------------------------------------------------
    13) Small Helpers
---------------------------------------------------------*/
function renderEmptyState() {
    document.getElementById('hero-section').innerHTML = `
        <div class="lg:col-span-12 h-64 flex items-center justify-center text-gray-500 border border-dashed border-white/10 rounded-2xl">
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø±.
        </div>`;
}

function renderMock(msg) {
    const mock = [
        {
            id: "1",
            title: "Ø§Ù†Ø·Ù„Ø§Ù‚ ØµØ­ÙŠÙØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© Ø¨Ø­Ù„ØªÙ‡Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©",
            category: "Ø£Ø®Ø¨Ø§Ø±",
            date: "Ø§Ù„Ø¢Ù†",
            img: "https://images.unsplash.com/photo-1504711434969-e33886168f5c",
            desc: "Ù†Ø¹Ù„Ù† Ø§Ù„ÙŠÙˆÙ… Ø¹Ù† Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©..."
        }
    ];
    renderSite(mock);
    document.getElementById('ticker-content').innerText = msg;
}

function showToast(msg) {
    const toastMsg = document.getElementById('toast-msg');
    const toast = document.getElementById('toast');
    
    toastMsg.innerText = msg;
    toast.classList.remove("translate-y-24", "opacity-0");

    setTimeout(() => {
        toast.classList.add("translate-y-24", "opacity-0");
    }, 3000);
}
</script>

</body>
</html>
