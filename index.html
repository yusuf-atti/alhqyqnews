/* ====================================================
   1) ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
==================================================== */
function initIcons() {
    if (window.lucide) lucide.createIcons();
}
document.addEventListener('DOMContentLoaded', initIcons);

/* ====================================================
   2) Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
==================================================== */
const firebaseConfig = {
    apiKey: "AIzaSyD7b1PZY26GN6hR2pliqiFRgyMsNyRlWOs",
    authDomain: "alhqyq-62b0e.firebaseapp.com",
    projectId: "alhqyq-62b0e",
    storageBucket: "alhqyq-62b0e.firebasestorage.app",
    messagingSenderId: "354014970954",
    appId: "1:354014970954:web:435ca4eb0cbbfcfd1152b3"
};

let isOfflineMode = false;
const LOCAL_NEWS_KEY = "local_news_db";
let newsData = [];

/* ====================================================
   3) Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Firebase
==================================================== */
try {
    firebase.initializeApp(firebaseConfig);
    console.log("âœ… Firebase ØªÙ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø©");
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    auth.onAuthStateChanged((user) => {
        console.log("ğŸ‘¤ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", user ? "Ù…Ø³Ø¬Ù„" : "Ø²Ø§Ø¦Ø±");
    });
    
    // Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø± ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
    auth.signInAnonymously()
        .then(() => loadNewsFromFirestore())
        .catch(() => {
            console.warn("âš ï¸ ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„");
            loadLocalNews();
        });
        
} catch (error) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Firebase:", error);
    isOfflineMode = true;
    loadLocalNews();
}

/* ====================================================
   4) Ø¯ÙˆØ§Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
==================================================== */
async function loadNewsFromFirestore() {
    try {
        const snapshot = await firebase.firestore()
            .collection("news")
            .orderBy("timestamp", "desc")
            .limit(20)
            .get();
        
        if (snapshot.empty) {
            console.log("ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            loadLocalNews();
            return;
        }
        
        newsData = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${newsData.length} Ø®Ø¨Ø±`);
        renderSite(newsData);
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±:", error);
        isOfflineMode = true;
        loadLocalNews();
    }
}

function loadLocalNews() {
    try {
        const stored = localStorage.getItem(LOCAL_NEWS_KEY);
        if (stored) {
            newsData = JSON.parse(stored);
        }
    } catch(e) { }
    
    if (newsData.length === 0) {
        newsData = [{
            id: "1",
            title: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ ØµØ­ÙŠÙØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©",
            category: "Ø£Ø®Ø¨Ø§Ø±",
            img: "https://images.unsplash.com/photo-1504711434969-e33886168f5c",
            desc: "Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±. Ø¬Ø§Ø±ÙŠ Ø±Ø¨Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...",
            author: "ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ­Ø±ÙŠØ±",
            date: new Date().toLocaleDateString("ar-SA"),
            timestamp: { seconds: Date.now() / 1000 }
        }];
    }
    
    renderSite(newsData);
    document.getElementById('status-bar').classList.remove('hidden');
}

/* ====================================================
   5) Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹
==================================================== */
function renderSite(news) {
    if (!news || news.length === 0) {
        showEmptyState();
        return;
    }
    
    const hero = news[0];
    const rest = news.slice(1);
    
    // Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¹Ø§Ø¬Ù„Ø©
    document.getElementById('ticker-content').innerText = 
        " â€¢ " + news.map(n => n.title).join(" â€¢ ");
    
    // Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    document.getElementById('hero-section').innerHTML = `
        <div onclick="openArticle('${hero.id}')"
            class="lg:col-span-12 relative group rounded-2xl overflow-hidden h-[300px] lg:h-[450px] cursor-pointer border border-white/10 hover:border-gold-400/50 transition-all duration-300">
            
            <img src="${hero.img}" 
                 class="w-full h-full object-cover group-hover:scale-105 transition duration-700"
                 onerror="this.src='https://via.placeholder.com/800x400/0a0a15/ffffff?text=Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©+Ù†ÙŠÙˆØ²'">
            
            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent"></div>
            
            <div class="absolute bottom-0 p-6 lg:p-10">
                <span class="bg-gold-400 text-black text-xs font-bold px-3 py-1 rounded-full mb-3 inline-block">
                    ${hero.category}
                </span>
                <h1 class="text-2xl md:text-4xl font-black text-white mb-3">${hero.title}</h1>
                <p class="text-gray-200 text-sm hidden md:block max-w-2xl">${hero.desc.substring(0, 150)}...</p>
            </div>
        </div>`;
    
    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
    document.getElementById('news-container').innerHTML = rest.map((n, index) => `
        <div onclick="openArticle('${n.id}')"
            class="flex gap-4 p-4 bg-white/5 rounded-xl border border-white/5 hover:border-gold-400/30 cursor-pointer group transition-all">
            
            <div class="w-24 h-24 flex-shrink-0 overflow-hidden rounded-lg">
                <img src="${n.img}" 
                     class="w-full h-full object-cover group-hover:scale-110 transition duration-500"
                     onerror="this.src='https://via.placeholder.com/200'">
            </div>
            
            <div class="flex-1">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gold-400 text-xs font-bold">${n.category}</span>
                    <span class="text-gray-500 text-xs">${n.date || ''}</span>
                </div>
                <h3 class="text-white font-bold text-lg leading-tight group-hover:text-gold-400 transition">
                    ${n.title}
                </h3>
                <p class="text-gray-400 text-sm mt-2 line-clamp-2">${n.desc.substring(0, 100)}...</p>
            </div>
        </div>
    `).join('');
    
    // Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ (Ø§Ù„Ø£ÙƒØ«Ø± Ù‚Ø±Ø§Ø¡Ø©)
    const trending = [...news].sort(() => 0.5 - Math.random()).slice(0, 5);
    document.getElementById('sidebar-content').innerHTML = trending.map((n, i) => `
        <div onclick="openArticle('${n.id}')"
            class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 cursor-pointer group border-b border-white/5 last:border-0">
            
            <div class="w-8 h-8 flex items-center justify-center bg-gold-400/20 text-gold-400 rounded-full font-bold">
                ${i + 1}
            </div>
            
            <div class="flex-1">
                <h4 class="text-sm text-white group-hover:text-gold-400 transition line-clamp-2">
                    ${n.title}
                </h4>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-xs text-gray-500">${n.category}</span>
                    <span class="text-xs text-gray-700">â€¢</span>
                    <span class="text-xs text-gray-500">${n.date || ''}</span>
                </div>
            </div>
        </div>
    `).join('');
    
    initIcons();
}

function showEmptyState() {
    document.getElementById('hero-section').innerHTML = `
        <div class="lg:col-span-12 flex flex-col items-center justify-center h-64 rounded-2xl border-2 border-dashed border-white/10 text-center p-8">
            <i data-lucide="newspaper" class="w-12 h-12 text-gray-600 mb-4"></i>
            <h3 class="text-xl font-bold text-white mb-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
            <p class="text-gray-500">Ø³ÙŠØªÙ… Ù†Ø´Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ù‚Ø±ÙŠØ¨Ø§Ù‹</p>
        </div>`;
    initIcons();
}

/* ====================================================
   6) Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù‚Ø§Ù„
==================================================== */
window.openArticle = (id) => {
    const article = newsData.find(n => n.id === id);
    if (!article) return;
    
    document.getElementById('modal-img').src = article.img;
    document.getElementById('modal-cat').textContent = article.category;
    document.getElementById('modal-title').textContent = article.title;
    document.getElementById('modal-date').textContent = article.date || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    document.getElementById('modal-author').textContent = article.author || 'ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ­Ø±ÙŠØ±';
    document.getElementById('modal-body').innerHTML = marked.parse(article.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰');
    
    document.getElementById('article-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
};

window.closeArticleModal = () => {
    document.getElementById('article-modal').classList.add('hidden');
    document.body.style.overflow = 'auto';
};

/* ====================================================
   7) Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
==================================================== */
window.handleRealLogin = async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('login-email').value || "admin@alhqyq.com";
    const password = document.getElementById('login-password').value || "Admin123456";
    
    try {
        await firebase.auth().signInWithEmailAndPassword(email, password);
        document.getElementById('login-error').classList.add('hidden');
        showToast("âœ… ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­");
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        document.getElementById('login-gate').classList.add('hidden');
        document.getElementById('dashboard-ui').classList.remove('hidden');
        
    } catch(error) {
        document.getElementById('login-error').innerHTML = `
            <div class="flex items-center gap-2">
                <i data-lucide="alert-circle" class="w-4 h-4"></i>
                <span>Ø®Ø·Ø£: ${error.message}</span>
            </div>`;
        document.getElementById('login-error').classList.remove('hidden');
        initIcons();
    }
};

window.publishAction = async () => {
    const title = document.getElementById('news-title').value.trim();
    const category = document.getElementById('news-category').value;
    const img = document.getElementById('news-image').value || "https://images.unsplash.com/photo-1504711434969-e33886168f5c";
    const content = document.getElementById('editor').innerText.trim();
    
    if (!title || !content) {
        alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰");
        return;
    }
    
    const btn = document.getElementById('publish-btn');
    btn.disabled = true;
    btn.innerHTML = '<div class="loader mx-auto"></div>';
    
    const article = {
        title,
        category,
        img,
        desc: content,
        author: firebase.auth().currentUser?.email || "Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…",
        date: new Date().toLocaleDateString("ar-SA"),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        await firebase.firestore().collection("news").add(article);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        const newArticle = { id: "new_" + Date.now(), ...article };
        newsData.unshift(newArticle);
        localStorage.setItem(LOCAL_NEWS_KEY, JSON.stringify(newsData));
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        renderSite(newsData);
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('news-title').value = "";
        document.getElementById('editor').innerText = "";
        document.getElementById('news-image').value = "";
        
        showToast("ğŸš€ ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø± Ø¨Ù†Ø¬Ø§Ø­");
        
    } catch(error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø´Ø±:", error);
        showToast("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù†Ø´Ø±");
    } finally {
        btn.disabled = false;
        btn.textContent = "Ù†Ø´Ø± ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ğŸš€";
    }
};

/* ====================================================
   8) Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
==================================================== */
function showToast(msg) {
    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toast-msg');
    
    toastMsg.textContent = msg;
    toast.classList.remove("translate-y-24", "opacity-0");
    
    setTimeout(() => {
        toast.classList.add("translate-y-24", "opacity-0");
    }, 3000);
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener('click', (e) => {
    if (e.target.id === 'article-modal') {
        closeArticleModal();
    }
});

// Ø¥Ø¶Ø§ÙØ© Ø£Ø®Ø¨Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©
window.addSampleNews = async () => {
    const sampleArticles = [
        {
            title: "Ø§Ù†Ø·Ù„Ø§Ù‚ Ù…Ù†ØµØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©",
            category: "Ø£Ø®Ø¨Ø§Ø±",
            img: "https://images.unsplash.com/photo-1504711434969-e33886168f5c",
            desc: "ØªÙ… Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¹Ù† Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„ØµØ­ÙŠÙØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©ØŒ Ø§Ù„ØªÙŠ ØªÙ‚Ø¯Ù… ØªØ¬Ø±Ø¨Ø© Ù‚Ø±Ø§Ø¡Ø© ÙØ±ÙŠØ¯Ø© Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.",
            author: "ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ­Ø±ÙŠØ±"
        },
        {
            title: "ØªØ·ÙˆØ±Ø§Øª Ø§Ù‚ØªØµØ§Ø¯ÙŠØ© Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©",
            category: "Ø§Ù‚ØªØµØ§Ø¯",
            img: "https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3",
            desc: "Ø³Ø¬Ù„Øª Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù†Ù…ÙˆØ§Ù‹ Ù…Ù„Ø­ÙˆØ¸Ø§Ù‹ Ø®Ù„Ø§Ù„ Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø®ÙŠØ±ØŒ Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¨ØªØ­Ø³Ù† Ø¨ÙŠØ¦Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±.",
            author: "Ù‚Ø³Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯"
        }
    ];
    
    for (const article of sampleArticles) {
        await firebase.firestore().collection("news").add({
            ...article,
            date: new Date().toLocaleDateString("ar-SA"),
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
    
    alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ø®Ø¨Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠØ©");
    location.reload();
};
