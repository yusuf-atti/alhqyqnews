<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>صحيفة الحقيقة الذكية</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* ... (الأنماط كما هي) ... */
        body { background-color: #050510; color: #f3f4f6; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-left-color: #D4AF37; width: 24px; height: 24px; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <header class="fixed top-0 w-full z-50 glass-header">
        </header>
    <aside id="main-sidebar" class="sidebar fixed inset-y-0 right-0 w-72 bg-[#1a1d26] z-[60] shadow-2xl border-l border-white/10 overflow-y-auto">
        </aside>
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-50 hidden backdrop-blur-sm"></div>


    <main class="pt-32 pb-20 container mx-auto px-4 min-h-screen">
        
        <section id="view-home" class="view-section">
            </section>

        <section id="view-features" class="view-section hidden">
            </section>

        <section id="view-contract" class="view-section hidden max-w-2xl mx-auto">
            <div class="bg-navy-800 border border-white/10 rounded-2xl p-6 shadow-2xl">
                <h2 class="text-2xl font-bold text-white mb-4 text-center">عقد توظيف إلكتروني</h2>
                <p class="text-gray-400 text-sm text-center mb-6">الرقم الوظيفي: <span id="job-id-display" class="text-gold-400 font-mono">HR-TEMP-001</span></p>
                
                <form id="contract-form" onsubmit="submitEmployeeContract(event)" class="space-y-4">
                    <input type="text" name="name" id="rec-name" required class="w-full bg-black/50 border border-white/10 rounded-lg p-3 text-white focus:border-gold-400 outline-none" placeholder="الاسم الثلاثي">
                    <input type="email" name="email" id="rec-email" required class="w-full bg-black/50 border border-white/10 rounded-lg p-3 text-white focus:border-gold-400 outline-none" placeholder="البريد الإلكتروني">
                    <input type="text" name="civil_id" id="rec-civil-id" required class="w-full bg-black/50 border border-white/10 rounded-lg p-3 text-white focus:border-gold-400 outline-none" placeholder="رقم الهوية / السجل المدني (1xxxxxxxxx)">
                    
                    <div class="flex gap-4">
                        <label class="flex items-center text-white"><input type="radio" name="gender" value="male" required class="w-4 h-4 ml-2"> ذكر</label>
                        <label class="flex items-center text-white"><input type="radio" name="gender" value="female" required class="w-4 h-4 ml-2"> أنثى</label>
                    </div>

                    <label class="block text-sm font-medium text-gray-300">الصورة الشخصية (إجبارية للذكور):</label>
                    <input type="file" name="photo" id="rec-photo" accept="image/*" class="w-full bg-black/50 border border-white/10 rounded-lg p-3 text-white/50 file:ml-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gold-400 file:text-black hover:file:bg-gold-500">

                    <button type="submit" id="submit-contract-btn" class="w-full bg-gold-400 text-black font-bold py-3 rounded-lg hover:bg-white transition">توثيق العقد وإرسال</button>
                </form>
            </div>
        </section>

        <section id="view-dashboard" class="view-section hidden">
            </section>

        <section id="view-admin" class="view-section hidden">
            <div id="admin-panel" class="hidden space-y-6">
                <div class="bg-navy-800 p-6 rounded-2xl border border-white/10 max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-white">إدارة الكوادر والموارد البشرية</h2>
                        <button onclick="generateInviteLink()" id="btn-generate-invite" class="bg-gold-400 text-black px-4 py-2 rounded-lg font-bold text-sm hover:bg-gold-500 transition">توليد رابط توظيف</button>
                    </div>
                    
                    <div id="invite-box" class="hidden bg-black/30 p-4 rounded-xl mb-6 border border-gold-400/30">
                        <p class="text-xs text-gold-400">رابط الدعوة (إرسال عبر البريد الرسمي):</p>
                        <input type="text" id="invite-link-val" readonly class="w-full bg-transparent text-white text-xs font-mono py-1 border-none">
                        <p id="temp-password-display" class="text-xs text-gray-400 mt-2">كلمة المرور المؤقتة: <span class="font-bold text-white"></span></p>
                    </div>
                    
                    <h3 class="text-lg font-bold text-white mb-4 mt-6 border-r-4 border-white pr-3">الهيكل الإداري</h3>
                    <div class="bg-black/30 p-4 rounded-xl h-48 flex items-center justify-center text-gray-500">
                        

[Image of organizational chart]

                    </div>
                </div>
            </div>
        </section>
        
        </main>

    <script>
        // ====================================================================
        // إعدادات API والتوجيه (Routing)
        // ====================================================================
        
        // يجب أن يطابق هذا المسار مسار الـ Router الذي يوجه الطلبات إلى HRController.php
        const API_BASE_URL = '/api/hr/'; 
        
        // ====================================================================
        // الدوال المدمجة والمصححة
        // ====================================================================

        // دالة لعرض رسالة سريعة
        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            const msgSpan = document.getElementById('toast-msg');
            t.classList.remove('bg-green-600', 'bg-red-600', 'opacity-0');
            t.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
            msgSpan.innerText = msg;
            setTimeout(() => t.classList.add('opacity-0'), 4000);
        }

        // 1. توليد رابط الدعوة (يرسل طلب GET إلى HRController)
        window.generateInviteLink = async () => {
            const inviteBox = document.getElementById('invite-box');
            const inviteLinkInput = document.getElementById('invite-link-val');
            const tempPasswordSpan = document.querySelector('#temp-password-display span');
            const btn = document.getElementById('btn-generate-invite'); 
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<div class="loader ml-2"></div> جاري التوليد...';
            btn.disabled = true;

            try {
                const response = await fetch(API_BASE_URL + 'generate-invite');
                const data = await response.json();

                if (data.success) {
                    inviteLinkInput.value = data.link;
                    tempPasswordSpan.innerText = data.temp_password;
                    inviteBox.classList.remove('hidden');
                    
                    showToast("تم توليد الرابط وكلمة المرور.");
                } else {
                    showToast(data.message || "فشل توليد الرابط (تحقق من الخادم).", true);
                }

            } catch (error) {
                console.error('Error generating invite link:', error);
                showToast("خطأ في الاتصال بـ API: تأكد من التوجيه (Routing).", true);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // 2. إرسال نموذج العقد (يرسل طلب POST إلى HRController)
        window.submitEmployeeContract = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-contract-btn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<div class="loader ml-2"></div> جاري التوثيق...';
            btn.disabled = true;

            // جمع البيانات في FormData (ضروري للملفات والصور)
            const form = document.getElementById('contract-form');
            const formData = new FormData(form);
            
            try {
                // إرسال البيانات إلى HRController::submitContract()
                const response = await fetch(API_BASE_URL + 'submit-contract', {
                    method: 'POST',
                    body: formData 
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message);
                    form.reset(); // تفريغ النموذج عند النجاح
                } else {
                    showToast(data.message || "فشل توثيق العقد.", true);
                }

            } catch (error) {
                console.error('Error submitting contract:', error);
                showToast("خطأ في الاتصال بالخادم أو معالجة الطلب.", true);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
        
        // ... (بقية الدوال المساعدة: initIcons, fetchNews, toggleSidebar, toggleAdminView, إلخ.)
        // تأكد من الاحتفاظ بجميع الدوال التي كانت موجودة في <script> سابقاً.
    </script>
</body>
</html>
