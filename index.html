<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>صحيفة الحقيقة | الرؤية الجديدة</title>
    
    <!-- إعدادات التطبيق (PWA) -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050510">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://alhqyq.com/contents/datastore/layouts/41/logos/logo.jpg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- ✅ مكتبة الأيقونات (نسخة UMD المصححة) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- مكتبات Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Tajawal', 'sans-serif'] },
                    colors: { navy: { 900: '#050510', 800: '#0a0a15' }, gold: { 400: '#D4AF37' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050510; color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .glass-nav { background: rgba(5, 5, 16, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .loader { border: 4px solid rgba(255,255,255,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #D4AF37; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased selection:bg-gold-400 selection:text-black pb-20 md:pb-0">

    <!-- القائمة العلوية -->
    <nav class="fixed w-full z-50 glass-nav top-0">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">
            <div class="text-3xl font-black text-gold-400 cursor-pointer flex items-center gap-2 tracking-tighter" onclick="window.location.reload()">
                الـحقيقة<span class="text-white">.</span>
            </div>
            
            <div class="flex gap-3 items-center">
                <button id="install-btn" class="hidden bg-gold-400 text-black text-xs font-bold px-3 py-1.5 rounded-full animate-pulse flex items-center gap-1">
                    <i data-lucide="download" class="w-3 h-3"></i> تثبيت
                </button>

                <button onclick="openSettings()" class="text-gold-400 p-2 rounded-full hover:bg-white/10">
                    <i data-lucide="cpu" class="w-5 h-5"></i>
                </button>
                
                <a href="dashboard.html" class="text-white bg-white/10 p-2 rounded-full hover:bg-gold-400 hover:text-black transition-all">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- شريط الأخبار -->
    <div class="fixed top-16 w-full z-40 bg-navy-900 border-b border-white/5 py-2 overflow-hidden">
        <div class="container mx-auto px-4 flex items-center">
            <span class="text-gold-400 text-[10px] font-bold ml-3 border-l border-gray-700 px-2 whitespace-nowrap">عاجل</span>
            <div class="w-full overflow-hidden relative h-4">
                <div class="absolute whitespace-nowrap animate-[marquee_20s_linear_infinite] text-[10px] text-gray-300" id="ticker-content">
                    جاري الاتصال...
                </div>
            </div>
        </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <main class="pt-28 container mx-auto px-4 min-h-screen">
        <section class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-10" id="hero-section">
            <div class="lg:col-span-12 flex flex-col items-center justify-center h-64 gap-4 border border-white/5 rounded-2xl bg-white/5">
                <div class="loader"></div>
                <p class="text-gray-500 text-xs">جاري تحميل الأخبار...</p>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8" id="news-container">
                <div class="space-y-4">
                    <div class="h-24 bg-white/5 rounded-xl animate-pulse"></div>
                    <div class="h-24 bg-white/5 rounded-xl animate-pulse"></div>
                </div>
            </div>

            <div class="lg:col-span-4 hidden lg:block sticky top-32 h-fit">
                <div class="bg-navy-800/50 p-6 rounded-2xl border border-white/5">
                    <h3 class="text-gold-400 font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-4 h-4"></i> الأكثر قراءة
                    </h3>
                    <div id="sidebar-content" class="space-y-4"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- إعدادات AI Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[80] bg-black/90 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-navy-800 w-full max-w-sm rounded-2xl p-6 border border-gold-400/20 shadow-2xl">
            <h3 class="text-white font-bold mb-4 text-lg">إعدادات الذكاء الاصطناعي</h3>
            <input type="password" id="api-key-input" placeholder="Gemini API Key" class="w-full bg-black/50 p-3 rounded-xl text-white mb-4 border border-white/10 focus:border-gold-400 outline-none text-sm">
            <div class="flex gap-3">
                <button onclick="saveApiKey()" class="flex-1 bg-gold-400 text-black font-bold py-2 rounded-xl hover:bg-white transition">حفظ</button>
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="flex-1 bg-white/10 text-white py-2 rounded-xl">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        // دالة آمنة لتحميل الأيقونات
        function initIcons() {
            if (window.lucide) {
                lucide.createIcons();
            } else {
                console.warn("Lucide icons not loaded yet.");
            }
        }

        // ⚠️⚠️⚠️ منطقة إعدادات FIREBASE ⚠️⚠️⚠️
        const firebaseConfig = {
          apiKey: "AIzaSyD7b1PZY26GN6hR2pliqiFRgyMsNyRlWOs",
          authDomain: "alhqyqa-62b0e.firebaseapp.com",
          projectId: "alhqyqa-62b0e",
          storageBucket: "alhqyqa-62b0e.firebasestorage.app",
          messagingSenderId: "354014970954",
          appId: "1:354014970954:web:435ca4eb0cbbfcfd1152b3"
        };

        // PWA Install Logic
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installBtn = document.getElementById('install-btn');
            installBtn.classList.remove('hidden');
            installBtn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') installBtn.classList.add('hidden');
                    deferredPrompt = null;
                });
            });
        });

        // تهيئة التطبيق
        try {
            if (firebase.apps.length === 0) {
                firebase.initializeApp(firebaseConfig);
            }
            const auth = firebase.auth();
            const db = firebase.firestore();

            // المصادقة وجلب البيانات
            auth.signInAnonymously().catch(console.error);
            auth.onAuthStateChanged((user) => { if (user) fetchNews(); });

            async function fetchNews() {
                try {
                    const snapshot = await db.collection("news").limit(20).get();
                    if (snapshot.empty) { renderEmptyState(); return; }
                    
                    let newsData = snapshot.docs.map(doc => doc.data());
                    // الترتيب في المتصفح
                    newsData.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    renderSite(newsData);
                } catch (error) {
                    console.error("Data Error:", error);
                    renderMockData();
                }
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
            renderMockData();
        }

        let userApiKey = localStorage.getItem('gemini_api_key') || "";
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function saveApiKey() { 
            const key = document.getElementById('api-key-input').value;
            if(key) { localStorage.setItem('gemini_api_key', key); userApiKey = key; document.getElementById('settings-modal').classList.add('hidden'); }
        }

        function renderSite(news) {
            const hero = news[0];
            const others = news.slice(1);
            
            document.getElementById('ticker-content').innerText = "• " + news.map(n => n.title).join(" •       ");

            document.getElementById('hero-section').innerHTML = `
                <div class="lg:col-span-12 relative group rounded-2xl overflow-hidden h-[300px] lg:h-[450px] cursor-pointer shadow-2xl border border-white/10">
                    <img src="${hero.img}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" onerror="this.src='https://via.placeholder.com/800x400?text=News'">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent"></div>
                    <div class="absolute top-4 right-4 bg-gold-400 text-black text-xs font-bold px-3 py-1 rounded-full shadow-lg z-10">
                        ${hero.category || 'رئيسي'}
                    </div>
                    <div class="absolute bottom-0 p-6 lg:p-10 w-full z-10">
                        <h1 class="text-2xl md:text-5xl font-black text-white mb-3 leading-tight drop-shadow-lg">${hero.title}</h1>
                        <p class="text-gray-200 text-sm md:text-lg line-clamp-2 mb-4 hidden md:block opacity-90">${hero.desc}</p>
                        <div class="flex items-center gap-4 text-gray-300 text-xs font-bold">
                            <span class="flex items-center gap-1 bg-black/30 px-2 py-1 rounded"><i data-lucide="clock" class="w-3 h-3"></i> ${hero.date}</span>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('news-container').innerHTML = others.map(n => `
                <div class="flex gap-4 mb-4 bg-white/5 p-3 rounded-xl border border-white/5 hover:border-gold-400/30 transition-all group cursor-pointer">
                    <div class="w-24 h-24 md:w-32 md:h-24 flex-shrink-0 overflow-hidden rounded-lg">
                        <img src="${n.img}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" onerror="this.src='https://via.placeholder.com/150?text=News'">
                    </div>
                    <div class="flex flex-col justify-center flex-1">
                        <span class="text-[10px] text-gold-400 font-bold mb-1">${n.category}</span>
                        <h3 class="text-white font-bold text-base md:text-lg mb-1 leading-snug group-hover:text-gold-400 transition-colors line-clamp-2">${n.title}</h3>
                        <div class="text-[10px] text-gray-500 mt-1 flex gap-2">
                            <span>${n.date}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            // Sidebar
            const randomNews = [...news].sort(() => 0.5 - Math.random()).slice(0, 5);
            document.getElementById('sidebar-content').innerHTML = randomNews.map((n, i) => `
                <div class="flex gap-3 items-center group cursor-pointer border-b border-white/5 pb-2 last:border-0">
                    <span class="text-gold-400 font-black text-lg opacity-50 group-hover:opacity-100 w-4">${i+1}</span>
                    <h4 class="text-gray-300 text-xs font-medium leading-snug group-hover:text-white transition-colors line-clamp-2">${n.title}</h4>
                </div>
            `).join('');
            
            initIcons();
        }

        function renderEmptyState() {
            document.getElementById('hero-section').innerHTML = `
                <div class="lg:col-span-12 flex flex-col items-center justify-center h-64 text-center border border-dashed border-white/10 rounded-2xl">
                    <i data-lucide="newspaper" class="w-12 h-12 text-gray-600 mb-4"></i>
                    <h2 class="text-xl font-bold text-white mb-2">الصحيفة جاهزة!</h2>
                    <p class="text-gray-500 text-sm">لم يتم نشر أخبار بعد.</p>
                </div>
            `;
            initIcons();
        }

        function renderMockData() {
            const mock = [
                { title: "الذكاء الاصطناعي يقود مستقبل الصحافة الرقمية", category: "تكنولوجيا", date: "الآن", img: "https://images.unsplash.com/photo-1485827404703-89b55fcc595e", desc: "كيف تغير التقنيات الحديثة طريقة استهلاكنا للأخبار؟" },
                { title: "افتتاح معرض الكتاب الدولي في الرياض", category: "ثقافة", date: "أمس", img: "https://images.unsplash.com/photo-1524995997946-a1c2e315a42f", desc: "مشاركة واسعة من دور النشر العالمية وحضور جماهيري كثيف." },
                { title: "ارتفاع مؤشرات الأسهم في تداولات اليوم", category: "اقتصاد", date: "أمس", img: "https://images.unsplash.com/photo-1611974765270-ca12586343bb", desc: "تحليل اقتصادي لأداء السوق المالية." }
            ];
            renderSite(mock);
            document.getElementById('ticker-content').innerText += " (نسخة تجريبية)";
        }
        
        document.addEventListener('DOMContentLoaded', initIcons);
    </script>
</body>
</html>
