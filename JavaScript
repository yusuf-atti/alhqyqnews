// Ù…Ù„Ù: app.js

// ----------------------------------------------------
// 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©)
// ----------------------------------------------------
const firebaseConfig = {
    apiKey: "YOUR_API_KEY", // <--- Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ù†Ø§
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // <--- Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ù†Ø§
    projectId: "YOUR_PROJECT_ID", // <--- Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ù†Ø§
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// ----------------------------------------------------
// 2. ØªÙ‡ÙŠØ¦Ø© Firebase
// ----------------------------------------------------
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ----------------------------------------------------
// 3. Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
// ----------------------------------------------------
// Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ ÙƒÙˆØ¯ Markdown Ø¥Ù„Ù‰ HTML (ØªØ³ØªØ®Ø¯Ù… Ù…ÙƒØªØ¨Ø© Marked.js)
function convertMarkdownToHtml(markdownText) {
    return marked.parse(markdownText || "");
}

// Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‚Ø§Ù„ (Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ù‚Ø§Ù„)
function openArticle(articleId) {
    console.log("ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ù…Ù‚Ø§Ù„ ID:", articleId);
    // ÙŠÙ…ÙƒÙ†Ùƒ ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹: window.location.href = `article.html?id=${articleId}`;
}

// Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù… (Ø§Ù„ØªØµÙÙŠØ©)
function filterArticles(category, clickedElement) {
    // 1. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Ø´Ø· (Ø§Ù„Ø°Ù‡Ø¨ÙŠ) Ù…Ù† ÙƒÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('text-gold-400', 'border-b-2', 'border-gold-400');
        link.classList.add('text-gray-300');
    });

    // 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Ø´Ø· Ù„Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡
    clickedElement.classList.remove('text-gray-300');
    clickedElement.classList.add('text-gold-400', 'border-b-2', 'border-gold-400');
    
    // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù…
    renderArticles(category);
}

// ----------------------------------------------------
// 4. Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª
// ----------------------------------------------------

// Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ù…Ù† Firestore Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
async function fetchArticles(category = 'all') { // ØªÙ‚Ø¨Ù„ category ÙƒÙ…Ø¹Ø§Ù…Ù„
    try {
        let articlesRef = db.collection("articles").orderBy("timestamp", "desc");
        
        // ğŸ’¡ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØµÙÙŠØ©: Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù‚Ø³Ù… Ù‡Ùˆ "Ø§Ù„ÙƒÙ„" Ø£Ùˆ "Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¹Ø§Ø¬Ù„Ø©"ØŒ Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø´Ø±Ø· Ø§Ù„ØªØµÙÙŠØ©
        if (category !== 'all' && category !== 'latest') {
            // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø°ÙŠ ÙŠØ·Ø§Ø¨Ù‚ Ø­Ù‚Ù„ category ÙÙŠ Firestore
            articlesRef = articlesRef.where("category", "==", category); 
        }

        const snapshot = await articlesRef.get();
        const articles = [];
        snapshot.forEach(doc => {
            articles.push({ id: doc.id, ...doc.data() });
        });
        return articles;
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª:", error);
        return [];
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ù…Ù‚Ø§Ù„ ÙØ±Ø¯ÙŠ
function createArticleCard(article) {
    // ... (Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©) ...
    const summary = article.content ? article.content.substring(0, 150) + '...' : '';
    const contentHtml = convertMarkdownToHtml(summary);
    
    const articleDate = article.timestamp ? 
        new Date(article.timestamp.seconds * 1000).toLocaleDateString('ar-EG') : 
        'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

    return `
        <div class="glass-panel p-6 rounded-xl shadow-lg animate-fade-in mb-8" data-article-id="${article.id}">
            <div class="flex justify-between items-start">
                <h2 class="text-2xl font-bold text-white mb-2 hover:text-gold-400 cursor-pointer transition duration-300">
                    ${article.title}
                </h2>
                <span class="text-xs text-gray-400">${articleDate}</span>
            </div>
            
            <p class="text-gray-300 mb-4 leading-relaxed">Ø¨ÙˆØ§Ø³Ø·Ø©: ${article.author || 'Ù…Ø­Ø±Ø± Ù…Ø¬Ù‡ÙˆÙ„'}</p>
            
            <div class="text-gray-400 text-sm leading-7">
                ${contentHtml}
            </div>

            <button class="inline-block mt-4 text-gold-400 hover:text-gold-500 font-medium transition duration-300 read-more-btn" data-id="${article.id}">
                Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…Ù‚Ø§Ù„ ÙƒØ§Ù…Ù„Ø§Ù‹ â†’
            </button>
        </div>
    `;
}

// Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª
async function renderArticles(category = 'all') { // ØªÙ‚Ø¨Ù„ category ÙƒÙ…Ø¹Ø§Ù…Ù„
    const container = document.getElementById('app-container');
    container.innerHTML = `<div class="flex justify-center items-center py-12"><div class="loader"></div></div>`; 

    const articles = await fetchArticles(category); // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù‚Ø³Ù… Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø¨
    
    container.innerHTML = ''; 

    if (articles.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-400 py-12">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ù„Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….</p>';
        return;
    }

    let htmlContent = '';
    articles.forEach(article => {
        htmlContent += createArticleCard(article);
    });

    container.innerHTML = htmlContent;
}

// ----------------------------------------------------
// 5. Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
// ----------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø§Ø¨Ø¯Ø£ Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª ÙÙŠ Ù‚Ø³Ù… "Ø§Ù„ÙƒÙ„"
    renderArticles('all'); 
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø²Ø± "Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…Ø²ÙŠØ¯"
    document.getElementById('app-container').addEventListener('click', (e) => {
        if (e.target.classList.contains('read-more-btn')) {
            const articleId = e.target.dataset.id;
            openArticle(articleId);
        }
    });
});
