<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ | Dashboard</title><script src="https://www.google.com/search?q=https://cdn.tailwindcss.com"></script><link href="https://www.google.com/search?q=https://fonts.googleapis.com/css2%3Ffamily%3DTajawal:wght%40300%3B400%3B500%3B700%3B900%26display%3Dswap" rel="stylesheet"><script src="https://www.google.com/search?q=https://unpkg.com/lucide%40latest/dist/umd/lucide.js"></script><script src="https://www.google.com/search?q=https://cdn.jsdelivr.net/npm/chart.js"></script><script src="https://www.google.com/search?q=https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script><script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: { sans: ['Tajawal', 'sans-serif'] },
                colors: { navy: { 950: '#020205', 900: '#050510', 800: '#0a0a15', 700: '#151525' }, gold: { 400: '#D4AF37', 500: '#C5A028' } },
                animation: { 'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
            }
        }
    }
</script>
<style>
    body { background-color: #020205; color: #e5e7eb; overflow: hidden; }
    .glass-panel { background: rgba(21, 21, 37, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); }
    .sidebar-link { transition: all 0.3s; border-right: 3px solid transparent; }
    .sidebar-link:hover, .sidebar-link.active { background: rgba(212, 175, 55, 0.1); color: #D4AF37; border-right-color: #D4AF37; }
    .editor-content:empty:before { content: attr(placeholder); color: #4b5563; }
    ::-webkit-scrollbar { width: 6px; background: #0a0a15; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    .stat-card { background: linear-gradient(145deg, rgba(21,21,37,0.9), rgba(10,10,21,0.9)); border: 1px solid rgba(255,255,255,0.05); }
    /* Reader Modal Styles */
    .reader-content h1 { font-size: 2em; font-weight: bold; margin-bottom: 0.5em; color: white; }
    .reader-content h2 { font-size: 1.5em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #D4AF37; }
    .reader-content p { margin-bottom: 1em; line-height: 1.8; color: #d1d5db; }
    .reader-content ul { list-style: disc; margin-right: 1.5em; margin-bottom: 1em; }
</style>
</head><body class="flex h-screen selection:bg-gold-400 selection:text-black"><!-- Login/Register Gate -->
<div id="login-gate" class="fixed inset-0 z-50 bg-[#020205] flex items-center justify-center transition-opacity duration-500">
    <div class="glass-panel p-10 rounded-3xl w-full max-w-md relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-transparent via-gold-400 to-transparent"></div>
        <h1 class="text-5xl font-black text-white mb-2 text-center tracking-tighter">Ø§Ù„Ù€Ø­Ù‚ÙŠÙ‚Ø©<span class="text-gold-400">.</span></h1>
        <p class="text-center text-gray-500 text-sm mb-8">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ</p>

        <div id="auth-forms">
            <!-- Login Form -->
            <form id="login-form" onsubmit="handleLogin(event)" class="space-y-5">
                <div class="space-y-1">
                    <label class="text-xs text-gold-400 font-bold mr-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="login-email" class="w-full bg-[#0a0a15] border border-white/10 rounded-xl py-3 px-4 text-white focus:border-gold-400 focus:outline-none transition-colors" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-gold-400 font-bold mr-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="login-password" class="w-full bg-[#0a0a15] border border-white/10 rounded-xl py-3 px-4 text-white focus:border-gold-400 focus:outline-none transition-colors" required>
                </div>
                <div id="login-error" class="text-red-500 text-xs text-center hidden bg-red-500/10 py-2 rounded-lg border border-red-500/20"></div>
                <button type="submit" id="login-btn" class="w-full bg-gold-400 hover:bg-gold-500 text-black font-black py-4 rounded-xl transition-all transform hover:scale-[1.02]">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
                <p class="text-center text-xs text-gray-400 mt-4">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" onclick="toggleAuthMode('register')" class="text-white underline hover:text-gold-400">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a></p>
            </form>

            <!-- Register Form -->
            <form id="register-form" onsubmit="handleRegister(event)" class="hidden space-y-5">
                <div class="space-y-1">
                    <label class="text-xs text-gold-400 font-bold mr-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="reg-name" class="w-full bg-[#0a0a15] border border-white/10 rounded-xl py-3 px-4 text-white focus:border-gold-400 focus:outline-none transition-colors" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-gold-400 font-bold mr-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="reg-email" class="w-full bg-[#0a0a15] border border-white/10 rounded-xl py-3 px-4 text-white focus:border-gold-400 focus:outline-none transition-colors" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs text-gold-400 font-bold mr-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="reg-password" class="w-full bg-[#0a0a15] border border-white/10 rounded-xl py-3 px-4 text-white focus:border-gold-400 focus:outline-none transition-colors" required>
                </div>
                <div id="reg-error" class="text-red-500 text-xs text-center hidden bg-red-500/10 py-2 rounded-lg border border-red-500/20"></div>
                <button type="submit" id="reg-btn" class="w-full bg-white hover:bg-gray-200 text-black font-black py-4 rounded-xl transition-all transform hover:scale-[1.02]">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</button>
                <p class="text-center text-xs text-gray-400 mt-4">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ <a href="#" onclick="toggleAuthMode('login')" class="text-gold-400 underline hover:text-white">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></p>
            </form>
        </div>
    </div>
</div>

<!-- Verification Banner -->
<div id="verification-banner" class="hidden fixed top-0 left-0 w-full bg-red-600/90 text-white text-xs py-2 px-4 z-[60] flex justify-between items-center backdrop-blur-md">
    <span>âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ£ÙƒÙŠØ¯ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒØ§ÙØ© Ø§Ù„Ù…ÙŠØ²Ø§Øª.</span>
    <button onclick="resendVerification()" class="underline hover:text-gray-200 font-bold">Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ¹ÙŠÙ„</button>
</div>

<!-- Reader Modal (For Preview) -->
<div id="reader-modal" class="hidden fixed inset-0 z-[70] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-[#0a0a15] w-full max-w-3xl h-[80vh] rounded-2xl border border-white/10 flex flex-col relative overflow-hidden shadow-2xl">
        <button onclick="closeReader()" class="absolute top-4 left-4 bg-black/50 hover:bg-red-500/50 text-white p-2 rounded-full transition-colors z-10"><i data-lucide="x" class="w-5 h-5"></i></button>
        <div class="h-48 w-full bg-navy-800 relative">
            <img id="reader-img" src="" class="w-full h-full object-cover opacity-50">
            <div class="absolute bottom-0 right-0 p-6 bg-gradient-to-t from-[#0a0a15] to-transparent w-full">
                <span id="reader-category" class="text-gold-400 text-xs font-bold uppercase tracking-widest"></span>
                <h2 id="reader-title" class="text-3xl font-black text-white mt-1"></h2>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-8 reader-content" id="reader-body">
            <!-- Content goes here -->
        </div>
        <div class="p-4 border-t border-white/5 flex justify-between items-center bg-[#050510]">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-xs">ğŸ‘¤</div>
                <div>
                    <p id="reader-author" class="text-xs font-bold text-white"></p>
                    <p id="reader-date" class="text-[10px] text-gray-500"></p>
                </div>
            </div>
            <button class="text-gold-400 text-xs hover:text-white">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù‚Ø§Ù„</button>
        </div>
    </div>
</div>

<!-- Dashboard UI -->
<div id="system-ui" class="hidden w-full h-full flex pt-0 transition-all duration-300">
    <aside class="w-72 bg-[#050510] border-l border-white/5 flex flex-col relative z-20">
        <div class="h-24 flex items-center px-8 border-b border-white/5"><h2 class="text-2xl font-black text-white">Ø§Ù„Ù€Ø­Ù‚ÙŠÙ‚Ø© <span class="text-gold-400">Hub</span></h2></div>
        <div class="flex-1 overflow-y-auto py-6 space-y-2 px-4">
             <button onclick="switchView('dashboard', this)" class="sidebar-link w-full flex items-center gap-4 px-4 py-3 text-gray-400 hover:bg-white/5 rounded-lg text-sm font-medium active">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </button>
             <button onclick="switchView('editor', this)" class="sidebar-link w-full flex items-center gap-4 px-4 py-3 text-gray-400 hover:bg-white/5 rounded-lg text-sm font-medium">
                <i data-lucide="pen-tool" class="w-5 h-5"></i> Ø§Ù„Ù…Ø­Ø±Ø± Ø§Ù„Ø°ÙƒÙŠ
            </button>
             <button onclick="switchView('articles', this)" class="sidebar-link w-full flex items-center gap-4 px-4 py-3 text-gray-400 hover:bg-white/5 rounded-lg text-sm font-medium">
                <i data-lucide="file-text" class="w-5 h-5"></i> Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª
            </button>
            <div class="my-4 border-t border-white/5"></div>
             <button onclick="switchView('settings', this)" class="sidebar-link w-full flex items-center gap-4 px-4 py-3 text-gray-400 hover:bg-white/5 rounded-lg text-sm font-medium">
                <i data-lucide="settings" class="w-5 h-5"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            </button>
        </div>
         <div class="p-6 border-t border-white/5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gray-800 border-2 border-gold-400 flex items-center justify-center text-xl overflow-hidden">
                    <span id="user-avatar">ğŸ‘¤</span>
                </div>
                <div class="overflow-hidden">
                    <p class="text-white text-sm font-bold truncate w-32" id="current-user-name">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</p>
                    <p class="text-gray-500 text-[10px] truncate w-32" id="current-user-email">email@example.com</p>
                    <button onclick="logout()" class="text-red-400 text-xs hover:text-red-300 mt-1">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 bg-[#020205] relative overflow-hidden flex flex-col transition-all" id="main-content">
        <header class="h-24 flex items-center justify-between px-10 border-b border-white/5 bg-[#020205]/80 backdrop-blur z-10">
            <h1 class="text-2xl font-bold text-white" id="page-title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
            <div class="flex items-center gap-4">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-xs text-gray-400">Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªØµÙ„</span>
            </div>
        </header>
        
        <div class="flex-1 overflow-y-auto p-10 scroll-smooth relative">
            
            <!-- 1. Dashboard Home View -->
            <div id="view-dashboard" class="view-section space-y-8 animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="stat-card p-6 rounded-2xl relative overflow-hidden group">
                        <div class="absolute -right-6 -top-6 w-24 h-24 bg-gold-400/10 rounded-full group-hover:bg-gold-400/20 transition-all"></div>
                        <h3 class="text-gray-400 text-sm font-medium mb-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª</h3>
                        <p class="text-4xl font-black text-white" id="stat-total-articles">0</p>
                    </div>
                    <div class="stat-card p-6 rounded-2xl relative overflow-hidden group">
                        <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/10 rounded-full group-hover:bg-blue-500/20 transition-all"></div>
                        <h3 class="text-gray-400 text-sm font-medium mb-2">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</h3>
                        <p class="text-4xl font-black text-white">12.5K</p> 
                    </div>
                    <div class="stat-card p-6 rounded-2xl relative overflow-hidden group">
                        <div class="absolute -right-6 -top-6 w-24 h-24 bg-green-500/10 rounded-full group-hover:bg-green-500/20 transition-all"></div>
                        <h3 class="text-gray-400 text-sm font-medium mb-2">Ø§Ù„Ø­Ø§Ù„Ø©</h3>
                        <p class="text-4xl font-black text-green-400">Ù†Ø´Ø·</p>
                    </div>
                </div>
                <div class="glass-panel p-6 rounded-2xl border border-white/5">
                    <h3 class="text-white font-bold mb-6">Ù†Ø´Ø§Ø· Ø§Ù„Ù†Ø´Ø± (Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±)</h3>
                    <div class="h-64 w-full">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 2. Editor View (Now supports Editing) -->
            <div id="view-editor" class="view-section hidden space-y-6">
                 <div class="flex justify-between items-center mb-2">
                    <h3 class="text-gold-400 font-bold hidden" id="edit-mode-indicator"> ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ <button onclick="resetEditor()" class="text-xs text-white bg-red-500/20 px-2 py-1 rounded ml-2">Ø¥Ù„ØºØ§Ø¡</button></h3>
                 </div>
                 <input type="hidden" id="edit-article-id">
                 <input type="text" id="news-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±..." class="w-full bg-transparent text-4xl font-black text-white border-none focus:ring-0 px-0 placeholder-gray-700">
                 <div class="grid grid-cols-2 gap-4">
                     <select id="news-category" class="bg-navy-800 border border-white/10 rounded-lg p-2 text-white focus:border-gold-400 outline-none"><option>Ø£Ø®Ø¨Ø§Ø± Ù…Ø­Ù„ÙŠØ©</option><option>Ø±ÙŠØ§Ø¶Ø©</option><option>Ø§Ù‚ØªØµØ§Ø¯</option><option>Ø«Ù‚Ø§ÙØ©</option><option>ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§</option></select>
                     <input type="text" id="news-image" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©..." class="bg-navy-800 border border-white/10 rounded-lg p-2 text-white focus:border-gold-400 outline-none">
                 </div>
                 <div class="relative group">
                    <div id="editor" class="editor-content w-full min-h-[300px] text-lg text-gray-300 leading-loose border border-white/5 p-6 rounded-xl bg-navy-800/50 focus:bg-navy-800 transition-colors outline-none" contenteditable="true" placeholder="Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù‡Ù†Ø§..."></div>
                    <div class="absolute bottom-4 left-4 text-xs text-gray-600 pointer-events-none">ÙŠØ¯Ø¹Ù… Markdown</div>
                 </div>
                 <button onclick="publishAction()" id="publish-btn" class="w-full bg-gold-400 hover:bg-gold-500 text-black font-bold py-4 rounded-xl transition-all shadow-lg shadow-gold-400/20">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
            </div>
            
            <!-- 3. Archive View (Now with Search, Delete, Edit) -->
            <div id="view-articles" class="view-section hidden space-y-6">
                 <div class="flex justify-between items-center mb-4 gap-4">
                     <h3 class="text-white font-bold text-xl whitespace-nowrap">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h3>
                     <div class="relative flex-1 max-w-md">
                        <input type="text" id="search-input" onkeyup="filterArticles()" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†..." class="w-full bg-navy-800 border border-white/10 rounded-lg py-2 px-4 pr-10 text-white focus:border-gold-400 outline-none text-sm">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-500"></i>
                     </div>
                     <button onclick="loadRealData()" class="text-gold-400 text-sm hover:text-white flex items-center gap-2 whitespace-nowrap"><i data-lucide="refresh-cw" class="w-4 h-4"></i> ØªØ­Ø¯ÙŠØ«</button>
                 </div>
                 <div class="glass-panel rounded-2xl overflow-hidden">
                    <div id="articles-list" class="text-gray-300 divide-y divide-white/5">
                        <div class="p-8 text-center text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    </div>
                 </div>
            </div>

            <!-- 4. Settings View -->
            <div id="view-settings" class="view-section hidden space-y-8">
                <div class="max-w-2xl">
                    <h3 class="text-white font-bold text-xl mb-6 border-b border-white/10 pb-4">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
                    
                    <div class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-sm text-gray-400">Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</label>
                            <input type="text" id="settings-name" class="w-full bg-navy-800 border border-white/10 rounded-lg p-3 text-white focus:border-gold-400 outline-none">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm text-gray-400">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <input type="text" id="settings-email" disabled class="w-full bg-navy-900 border border-white/5 rounded-lg p-3 text-gray-500 cursor-not-allowed">
                        </div>
                        <button onclick="updateProfileData()" class="bg-white/10 hover:bg-white/20 text-white px-6 py-2 rounded-lg transition-colors text-sm font-bold">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    </div>

                    <h3 class="text-white font-bold text-xl mb-6 mt-12 border-b border-white/10 pb-4 text-red-400">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</h3>
                    <button onclick="logout()" class="border border-red-500/30 text-red-400 hover:bg-red-500/10 px-6 py-3 rounded-lg transition-colors text-sm font-bold w-full text-right flex items-center gap-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† ÙƒØ§ÙØ© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
                    </button>
                </div>
            </div>

        </div>
    </main>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-6 left-6 bg-navy-900 border border-gold-400/50 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-32 transition-all duration-300 flex items-center gap-3 z-[100]">
    <div class="w-2 h-2 bg-gold-400 rounded-full animate-pulse"></div>
    <span id="toast-msg" class="font-bold text-sm">ØªÙ…</span>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendEmailVerification, signInWithCustomToken, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy, limit, deleteDoc, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // 1. Initialize Firebase with System Config (Essential for permissions)
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let currentUser = null;
    let chartInstance = null;
    let allArticlesCache = [];

    // Helper: Toast
    window.showToast = (msg) => {
        const t = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = msg;
        t.classList.remove('translate-y-32');
        setTimeout(() => t.classList.add('translate-y-32'), 3000);
    };

    // 2. Authentication
    
    // Initial silent auth check (try developer token first, but don't force anonymous if user has a real session)
    const initAuth = async () => {
        if (!auth.currentUser && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
             await signInWithCustomToken(auth, __initial_auth_token);
        }
    };
    initAuth();

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            // User is logged in
            document.getElementById('login-gate').classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => document.getElementById('login-gate').classList.add('hidden'), 500);
            
            document.getElementById('system-ui').classList.remove('hidden');
            
            // Update Sidebar Info
            document.getElementById('current-user-name').innerText = user.displayName || "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯";
            document.getElementById('current-user-email').innerText = user.email;
            document.getElementById('settings-name').value = user.displayName || "";
            document.getElementById('settings-email').value = user.email || "";

            // Check Email Verification
            if (!user.emailVerified && !user.isAnonymous) {
                document.getElementById('verification-banner').classList.remove('hidden');
                document.getElementById('main-content').classList.add('pt-8');
            } else {
                document.getElementById('verification-banner').classList.add('hidden');
                document.getElementById('main-content').classList.remove('pt-8');
            }

            // Initialize Views
            loadDashboardStats();
        } else {
            // User is logged out
            document.getElementById('system-ui').classList.add('hidden');
            document.getElementById('login-gate').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
        }
    });

    // Toggle Login/Register Forms
    window.toggleAuthMode = (mode) => {
        const loginForm = document.getElementById('login-form');
        const regForm = document.getElementById('register-form');
        
        if (mode === 'register') {
            loginForm.classList.add('hidden');
            regForm.classList.remove('hidden');
        } else {
            regForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        }
    };

    // Handle Login
    window.handleLogin = async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        const btn = document.getElementById('login-btn');
        const errDiv = document.getElementById('login-error');

        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
        btn.disabled = true;
        errDiv.classList.add('hidden');

        try {
            await signInWithEmailAndPassword(auth, email, pass);
            // onAuthStateChanged will handle the rest
        } catch (error) {
            console.error(error);
            let msg = "Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
            if (error.code === 'auth/invalid-credential') msg = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
            errDiv.innerText = msg;
            errDiv.classList.remove('hidden');
            btn.innerText = "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…";
            btn.disabled = false;
        }
    };

    // Handle Register
    window.handleRegister = async (e) => {
        e.preventDefault();
        const name = document.getElementById('reg-name').value;
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-password').value;
        const btn = document.getElementById('reg-btn');
        const errDiv = document.getElementById('reg-error');

        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...";
        btn.disabled = true;
        errDiv.classList.add('hidden');

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
            await updateProfile(userCredential.user, { displayName: name });
            await sendEmailVerification(userCredential.user);
            
            showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨! ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ¹ÙŠÙ„.");
            // onAuthStateChanged will handle login
        } catch (error) {
            console.error(error);
            let msg = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
            if (error.code === 'auth/email-already-in-use') msg = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹";
            if (error.code === 'auth/weak-password') msg = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹";
            errDiv.innerText = msg;
            errDiv.classList.remove('hidden');
            btn.innerText = "ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨";
            btn.disabled = false;
        }
    };

    window.logout = async () => {
        await signOut(auth);
        // Reset Forms
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
    };

    window.resendVerification = async () => {
        if (currentUser) {
            await sendEmailVerification(currentUser);
            showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹");
        }
    };

    window.updateProfileData = async () => {
        const newName = document.getElementById('settings-name').value;
        if (currentUser && newName) {
            try {
                await updateProfile(currentUser, { displayName: newName });
                document.getElementById('current-user-name').innerText = newName;
                showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
            } catch (e) {
                showToast("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: " + e.message);
            }
        }
    };

    // --- Article Logic with Edit/Delete ---

    window.resetEditor = () => {
        document.getElementById('news-title').value = '';
        document.getElementById('news-category').value = 'Ø£Ø®Ø¨Ø§Ø± Ù…Ø­Ù„ÙŠØ©';
        document.getElementById('news-image').value = '';
        document.getElementById('editor').innerText = '';
        document.getElementById('edit-article-id').value = '';
        document.getElementById('publish-btn').innerText = "Ù†Ø´Ø± Ø§Ù„Ø¢Ù†";
        document.getElementById('edit-mode-indicator').classList.add('hidden');
    };

    window.publishAction = async () => {
        if (!currentUser) return;

        // Check if verified (Optional strict mode)
        // if (!currentUser.emailVerified && !currentUser.isAnonymous) {
        //     if(!confirm("Ø¨Ø±ÙŠØ¯Ùƒ ØºÙŠØ± Ù…ÙØ¹Ù„. Ù‚Ø¯ ÙŠØªÙ… ØªÙ‚ÙŠÙŠØ¯ Ø¸Ù‡ÙˆØ± Ù…Ù‚Ø§Ù„Ø§ØªÙƒ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")) return;
        // }

        const btn = document.getElementById('publish-btn');
        const title = document.getElementById('news-title').value;
        const category = document.getElementById('news-category').value;
        const image = document.getElementById('news-image').value || "https://via.placeholder.com/800x400";
        const content = document.getElementById('editor').innerText;
        const editId = document.getElementById('edit-article-id').value;

        if(!title || !content) { showToast("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰"); return; }

        btn.innerText = editId ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«..." : "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...";
        btn.disabled = true;

        try {
            // Rule 1: Strict Path Structure /artifacts/{appId}/public/data/{collection}
            const newsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'news');
            
            if (editId) {
                // Update existing
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'news', editId);
                await updateDoc(docRef, {
                    title: title,
                    category: category,
                    img: image,
                    desc: content,
                    updatedAt: serverTimestamp()
                });
                showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø¨Ø± Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            } else {
                // Create new
                await addDoc(newsCollection, {
                    title: title,
                    category: category,
                    img: image,
                    desc: content,
                    author: currentUser.displayName || currentUser.email,
                    authorId: currentUser.uid,
                    date: new Date().toLocaleDateString('ar-SA'),
                    timestamp: serverTimestamp()
                });
                showToast("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø± Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            }

            resetEditor();
            btn.disabled = false;
            
            // Refresh data if in view
            loadRealData();
            loadDashboardStats();
        } catch (e) {
            console.error(e);
            showToast("Ø®Ø·Ø£: " + e.message);
            btn.disabled = false;
            btn.innerText = editId ? "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†" : "Ù†Ø´Ø± Ø§Ù„Ø¢Ù†";
        }
    };

    window.deleteArticle = async (id) => {
        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
        try {
            // Rule 1: Strict Path Structure
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'news', id));
            showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‚Ø§Ù„ ğŸ—‘ï¸");
            loadRealData();
            loadDashboardStats();
        } catch(e) {
            showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: " + e.message);
        }
    };

    window.editArticle = (id) => {
        const article = allArticlesCache.find(a => a.id === id);
        if (!article) return;

        document.getElementById('news-title').value = article.title;
        document.getElementById('news-category').value = article.category;
        document.getElementById('news-image').value = article.img;
        document.getElementById('editor').innerText = article.desc;
        document.getElementById('edit-article-id').value = id;
        
        document.getElementById('publish-btn').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†";
        document.getElementById('edit-mode-indicator').classList.remove('hidden');

        // Switch to editor view
        window.switchView('editor', document.querySelector('[onclick="switchView(\'editor\', this)"]'));
    };

    window.openReader = (id) => {
        const article = allArticlesCache.find(a => a.id === id);
        if (!article) return;
        
        document.getElementById('reader-img').src = article.img;
        document.getElementById('reader-category').innerText = article.category;
        document.getElementById('reader-title').innerText = article.title;
        document.getElementById('reader-body').innerHTML = marked.parse(article.desc);
        document.getElementById('reader-author').innerText = article.author;
        document.getElementById('reader-date').innerText = article.date;
        
        document.getElementById('reader-modal').classList.remove('hidden');
    };

    window.closeReader = () => {
        document.getElementById('reader-modal').classList.add('hidden');
    };

    window.loadRealData = async () => {
        if (!currentUser) return;

        const list = document.getElementById('articles-list');
        // Don't wipe content if just refreshing silently, but here we do for simplicity
        // list.innerHTML = `<div class="p-8 text-center text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;

        try {
            // Rule 2: No Complex Queries (No orderBy in Firestore query)
            const newsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'news');
            const snapshot = await getDocs(newsCollection);
            
            if (snapshot.empty) {
                list.innerHTML = `<div class="p-8 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ù„Ø§Øª Ù…Ù†Ø´ÙˆØ±Ø©.</div>`;
                allArticlesCache = [];
                return;
            }

            // Cache and Sort in memory
            allArticlesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            allArticlesCache.sort((a, b) => {
                const timeA = a.timestamp ? a.timestamp.seconds : 0;
                const timeB = b.timestamp ? b.timestamp.seconds : 0;
                return timeB - timeA;
            });

            filterArticles(); // Render based on current filter
            
            // Update stats counter
            document.getElementById('stat-total-articles').innerText = allArticlesCache.length;

        } catch(e) { 
            console.error(e); 
            list.innerHTML = `<div class="p-4 text-red-400 text-sm">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${e.message}</div>`;
        }
    };

    window.filterArticles = () => {
        const query = document.getElementById('search-input').value.toLowerCase();
        const list = document.getElementById('articles-list');
        
        const filtered = allArticlesCache.filter(a => {
            const t = a.title ? a.title.toLowerCase() : '';
            const c = a.category ? a.category.toLowerCase() : '';
            return t.includes(query) || c.includes(query);
        });
        
        if(filtered.length === 0) {
            list.innerHTML = `<div class="p-8 text-center text-gray-500">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬.</div>`;
            return;
        }

        list.innerHTML = filtered.map(d => `
            <div class="p-4 flex justify-between items-center hover:bg-white/5 transition-colors group">
                <div class="flex items-center gap-4 flex-1">
                    <div class="w-12 h-12 rounded-lg bg-navy-900 border border-white/10 overflow-hidden cursor-pointer" onclick="openReader('${d.id}')">
                        <img src="${d.img}" onerror="this.src='https://via.placeholder.com/100'" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity">
                    </div>
                    <div class="cursor-pointer" onclick="openReader('${d.id}')">
                        <h4 class="font-bold text-white text-sm group-hover:text-gold-400 transition-colors">${d.title}</h4>
                        <div class="flex items-center gap-2 text-xs text-gray-500">
                            <span class="bg-white/5 px-2 py-0.5 rounded">${d.category}</span>
                            <span>${d.author}</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="openReader('${d.id}')" class="p-2 hover:bg-blue-500/20 text-blue-400 rounded-lg transition-colors" title="Ù…Ø¹Ø§ÙŠÙ†Ø©"><i data-lucide="eye" class="w-4 h-4"></i></button>
                    <button onclick="editArticle('${d.id}')" class="p-2 hover:bg-green-500/20 text-green-400 rounded-lg transition-colors" title="ØªØ¹Ø¯ÙŠÙ„"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                    <button onclick="deleteArticle('${d.id}')" class="p-2 hover:bg-red-500/20 text-red-400 rounded-lg transition-colors" title="Ø­Ø°Ù"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            </div>
        `).join('');
        
        // Re-init icons for new content
        if (window.lucide) lucide.createIcons();
    };

    window.loadDashboardStats = async () => {
        // Re-fetch articles for the count
        await loadRealData();
        
        // Setup Chart
        const ctx = document.getElementById('activityChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        // Mock data for the chart visualization
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±'],
                datasets: [{
                    label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª',
                    data: [12, 19, 3, 5, 2, allArticlesCache.length], // Using real count for last month
                    borderColor: '#D4AF37',
                    backgroundColor: 'rgba(212, 175, 55, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    };

    // Navigation
    window.switchView = (v, btn) => {
        document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
        document.getElementById(`view-${v}`).classList.remove('hidden');
        
        document.querySelectorAll('.sidebar-link').forEach(e => e.classList.remove('active', 'bg-gold-400/10', 'text-gold-400', 'border-r-gold-400'));
        if(btn) {
            btn.classList.add('active');
        }
        
        // Update Header Title
        const titles = { 'dashboard': 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', 'editor': 'Ø§Ù„Ù…Ø­Ø±Ø± Ø§Ù„Ø°ÙƒÙŠ', 'articles': 'Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª', 'settings': 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª' };
        document.getElementById('page-title').innerText = titles[v] || 'Ø§Ù„Ù†Ø¸Ø§Ù…';

        if(v === 'articles') loadRealData();
        if(v === 'dashboard') loadDashboardStats();
        if(v !== 'editor') resetEditor(); // Exit edit mode if leaving editor
    };

    // Init Icons
    if (window.lucide) lucide.createIcons();
</script>
</body></html>