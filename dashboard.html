<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Tajawal', 'sans-serif'] },
                    colors: { navy: { 950: '#020205', 900: '#050510', 800: '#0a0a15', 700: '#151525' }, gold: { 400: '#D4AF37', 500: '#C5A028' } },
                    animation: { 'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020205; color: #e5e7eb; overflow: hidden; }
        .glass-panel { background: rgba(21, 21, 37, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); }
        .sidebar-link { transition: all 0.3s; border-right: 3px solid transparent; }
        .sidebar-link:hover, .sidebar-link.active { background: rgba(212, 175, 55, 0.1); color: #D4AF37; border-right-color: #D4AF37; }
        .editor-content:empty:before { content: attr(placeholder); color: #4b5563; }
        ::-webkit-scrollbar { width: 6px; background: #0a0a15; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .table-row-hover:hover td { background-color: rgba(255, 255, 255, 0.03); }
    </style>
</head>
<body class="flex h-screen selection:bg-gold-400 selection:text-black">

    <!-- Login Gate -->
    <div id="login-gate" class="fixed inset-0 z-50 bg-[#020205] flex items-center justify-center">
        <div class="glass-panel p-10 rounded-3xl w-full max-w-md">
            <h1 class="text-5xl font-black text-white mb-2 text-center">Ø§Ù„Ù€Ø­Ù‚ÙŠÙ‚Ø©<span class="text-gold-400">.</span></h1>
            <form onsubmit="handleRealLogin(event)" class="space-y-6 mt-8">
                <input type="email" id="login-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="w-full bg-[#0a0a15] border border-white/10 rounded-xl py-3 px-4 text-white">
                <input type="password" id="login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full bg-[#0a0a15] border border-white/10 rounded-xl py-3 px-4 text-white">
                <div id="login-error" class="text-red-500 text-xs text-center hidden">Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©</div>
                <button id="login-btn" class="w-full bg-gold-400 text-black font-bold py-4 rounded-xl">Ø¯Ø®ÙˆÙ„</button>
            </form>
        </div>
    </div>

    <!-- Dashboard UI -->
    <div id="system-ui" class="hidden w-full h-full flex">
        <aside class="w-72 bg-[#050510] border-l border-white/5 flex flex-col relative z-20">
            <div class="h-24 flex items-center px-8 border-b border-white/5"><h2 class="text-2xl font-black text-white">Ø§Ù„Ù€Ø­Ù‚ÙŠÙ‚Ø© <span class="text-gold-400">Hub</span></h2></div>
            <div class="flex-1 overflow-y-auto py-6 space-y-2 px-4">
                 <button onclick="switchView('editor', this)" class="sidebar-link w-full flex items-center gap-4 px-4 py-3 text-gray-400 hover:bg-white/5 rounded-lg text-sm font-medium active">
                    <i data-lucide="pen-tool" class="w-5 h-5"></i> Ø§Ù„Ù…Ø­Ø±Ø± Ø§Ù„Ø°ÙƒÙŠ
                </button>
                 <button onclick="switchView('articles', this)" class="sidebar-link w-full flex items-center gap-4 px-4 py-3 text-gray-400 hover:bg-white/5 rounded-lg text-sm font-medium">
                    <i data-lucide="file-text" class="w-5 h-5"></i> Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª
                </button>
            </div>
             <div class="p-6 border-t border-white/5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gray-800 border-2 border-gold-400 flex items-center justify-center text-xl">ğŸ‘¤</div>
                    <div>
                        <p class="text-white text-sm font-bold" id="current-user-name">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</p>
                        <button onclick="logout()" class="text-red-400 text-xs hover:text-red-300">Ø®Ø±ÙˆØ¬</button>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 bg-[#020205] relative overflow-hidden flex flex-col">
            <header class="h-24 flex items-center justify-between px-10 border-b border-white/5 bg-[#020205]/80 backdrop-blur z-10">
                <h1 class="text-2xl font-bold text-white">ØºØ±ÙØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h1>
            </header>
            
            <div class="flex-1 overflow-y-auto p-10 scroll-smooth relative">
                <!-- Editor View -->
                <div id="view-editor" class="view-section space-y-6">
                     <input type="text" id="news-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±..." class="w-full bg-transparent text-4xl font-black text-white border-none focus:ring-0 px-0">
                     <div class="grid grid-cols-2 gap-4">
                         <select id="news-category" class="bg-navy-800 border border-white/10 rounded-lg p-2 text-white"><option>Ø£Ø®Ø¨Ø§Ø± Ù…Ø­Ù„ÙŠØ©</option><option>Ø±ÙŠØ§Ø¶Ø©</option><option>Ø§Ù‚ØªØµØ§Ø¯</option><option>Ø«Ù‚Ø§ÙØ©</option></select>
                         <input type="text" id="news-image" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©..." class="bg-navy-800 border border-white/10 rounded-lg p-2 text-white">
                     </div>
                     <div id="editor" class="editor-content w-full h-[300px] text-lg text-gray-300 leading-loose border border-white/5 p-4 rounded-xl" contenteditable="true" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø®Ø¨Ø± Ù‡Ù†Ø§..."></div>
                     <button onclick="publishAction()" id="publish-btn" class="w-full bg-gold-400 text-black font-bold py-3 rounded-lg">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
                </div>
                
                <!-- Archive View -->
                <div id="view-articles" class="view-section hidden space-y-6">
                     <div class="flex justify-between"><h3 class="text-white font-bold">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h3><button onclick="loadRealData()" class="text-gold-400 text-sm">ØªØ­Ø¯ÙŠØ«</button></div>
                     <div id="articles-list" class="text-gray-300 space-y-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed bottom-6 left-6 bg-navy-900 border border-gold-400/50 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-24 opacity-0 transition-all duration-300 flex items-center gap-3 z-[100]">
        <span id="toast-msg" class="font-bold">ØªÙ…</span>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // 1. Initialize Firebase with System Config
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;
        let displayName = "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";

        // 2. Authentication
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth Error:", err);
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
        });

        // 3. Helper Functions
        const showToast = (msg) => {
            const t = document.getElementById('toast');
            if (!t) return;
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-24', 'opacity-0'), 3000);
        };

        // 4. UI Functions (Attached to window)
        
        window.handleRealLogin = (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;

            if (!email || !pass) {
                document.getElementById('login-error').innerText = "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„";
                document.getElementById('login-error').classList.remove('hidden');
                return;
            }

            displayName = email;
            document.getElementById('current-user-name').innerText = displayName;
            
            document.getElementById('login-gate').classList.add('hidden');
            document.getElementById('system-ui').classList.remove('hidden');
            
            window.loadRealData();
        };

        window.logout = () => {
            document.getElementById('system-ui').classList.add('hidden');
            document.getElementById('login-gate').classList.remove('hidden');
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
        };

        window.publishAction = async () => {
            if (!currentUser) {
                alert("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±");
                return;
            }

            const btn = document.getElementById('publish-btn');
            const title = document.getElementById('news-title').value;
            const category = document.getElementById('news-category').value;
            const image = document.getElementById('news-image').value || "https://via.placeholder.com/800x400";
            const content = document.getElementById('editor').innerText;

            if(!title || !content) { alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); return; }

            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...";
            btn.disabled = true;

            try {
                const newsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'news');
                
                await addDoc(newsCollection, {
                    title: title,
                    category: category,
                    img: image,
                    desc: content,
                    author: displayName,
                    date: new Date().toLocaleDateString('ar-SA'),
                    timestamp: serverTimestamp()
                });

                showToast("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø± Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                btn.innerText = "Ù†Ø´Ø± Ø§Ù„Ø¢Ù†";
                btn.disabled = false;
                
                document.getElementById('news-title').value = '';
                document.getElementById('editor').innerText = '';
                
                window.loadRealData();
            } catch (e) {
                console.error(e);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø±: " + e.message);
                btn.disabled = false;
                btn.innerText = "Ù†Ø´Ø± Ø§Ù„Ø¢Ù†";
            }
        };

        window.loadRealData = async () => {
            if (!currentUser) return;

            const list = document.getElementById('articles-list');
            list.innerHTML = `<div class="text-center py-4 text-gold-400">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>`;

            try {
                const newsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'news');
                const snapshot = await getDocs(newsCollection);
                
                if (snapshot.empty) {
                    list.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ù„Ø§Øª Ù…Ù†Ø´ÙˆØ±Ø©.";
                    return;
                }
                
                const docs = snapshot.docs.map(doc => doc.data());
                docs.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.seconds : Date.now()/1000;
                    const timeB = b.timestamp ? b.timestamp.seconds : Date.now()/1000;
                    return timeB - timeA;
                });

                list.innerHTML = docs.map(d => {
                    return `<div class="p-3 border-b border-white/10 flex justify-between items-center group hover:bg-white/5 transition-colors rounded-lg">
                        <span class="font-medium text-white">${d.title}</span>
                        <span class="text-xs text-gray-500 font-mono">${d.date || 'Ø§Ù„Ø¢Ù†'}</span>
                    </div>`;
                }).join('');

            } catch(e) { 
                console.error(e); 
                list.innerHTML = `<div class="text-red-400 text-sm">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${e.message}</div>`;
            }
        };

        window.switchView = (v, btn) => {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(`view-${v}`).classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-link').forEach(e => e.classList.remove('active', 'bg-gold-400/10', 'text-gold-400', 'border-r-gold-400'));
            if(btn) {
                btn.classList.add('active');
            }

            if(v === 'articles') window.loadRealData();
        }

        if (window.lucide) lucide.createIcons();
    </script>
</body>
</html>
